# Разделение идентификаторов узла и конфигурации

## Обзор

Чтобы повысить гибкость и удобство работы с DSC в режиме Pull, мы добавили в этот выпуск несколько функций. Они упрощают настройку и развертывание конфигураций на нескольких узлах и позволяют сохранить возможность отслеживания состояния и отчетов для каждого узла в отдельности. Эти функции представлены ниже:

* Имя конфигурации, определяющее конфигурацию для компьютера. Это имя может совместно использоваться несколькими целевыми узлами. 
* Идентификатор агента, который однозначно идентифицирует отдельный узел.
* Этап регистрации, который имеет место только при первом подключении целевого узла к опрашивающему серверу.

**Примечание.** Эти функции были добавлены и не заменяют собой существующие функциональные возможности и механизмы извлечения. Как новые, так и старые функции можно использовать с опрашивающим сервером, входящим в состав этого выпуска.

## Идентификатор агента

Эта функция предназначена для пользователей, которые не хотят настраивать уникальные идентификаторы для каждого целевого узла и управлять ими. Теперь вам больше не придется вести учет нужных GUID. DSC автоматически создает идентификатор агента, который используется при взаимодействии с опрашивающим сервером. Этот идентификатор используется сервером для однозначной идентификации всей информации с данным узлом. Это также означает, что не нужно настроить для каждого целевого узла уникальную метаконфигурацию с уникальным идентификатором. В результате одну метаконфигурацию может использовать множество целевых узлов, и при этом сохраняется уникальный идентификатор для каждого из узлов. 

## Имя конфигурации

Имя конфигурации — это понятное имя, определяющее конфигурацию, к которой будет применяться целевой узел. Здесь присутствуют следующие изменения:  

### Понятное имя

Им может быть все, что угодно. Соблюдать формат GUID не требуется, поэтому конфигурацию, которая настраивает SQL Server, можно назвать просто SQL_Server. Это помогает гораздо проще определить функции конкретной конфигурации.

### Назначение

Конфигурация, которой назначен целевой узел, централизованно управляется на опрашивающем сервере. Это можно включить в начальную загрузку, определив свойство ConfigrationName в метаконфигурации, однако такая процедура используется только во время регистрации. После регистрации сервер сообщает целевому узлу, какую конфигурацию он получит. Для локального опрашивающего сервера такое сопоставление между конфигурациями и целевыми узлами может выполняться только во время регистрации, но в службе автоматизации Azure эти изменения можно легко внести в пользовательском интерфейсе или с помощью командлетов. Чтобы изменить конфигурацию, назначенную целевому узлу, для локального опрашивающего сервера, необходимо повторно выполнить регистрацию.

### Множественные и неполные конфигурации

Если целевому узлу назначено несколько имен конфигураций, они будут считаться неполными конфигурациями. Чтобы это работало, метаконфигурация на целевом узле должна быть настроена на прием неполных конфигураций. **Примечание.** Такая процедура поддерживается только на локальном опрашивающем сервере. Служба автоматизации Azure не поддерживает неполные конфигурации.

## Регистрация

Поскольку имена конфигураций больше не являются GUID (теперь это понятные имена), любой пользователь понять их. Для устранения унаследованной проблемы безопасности мы добавили этап регистрации, который необходимо пройти, прежде чем узел может приступить к запросу конфигураций с сервера. Узел самостоятельно регистрируется на опрашивающем сервере с помощью общего секрета (который известен как узлу, так и серверу) и, при необходимости, имени запрашиваемой конфигурации. Этот общий секрет необязательно должен быть уникальным для каждого компьютера. Допущение: общий секрет — это трудный для понимания идентификатор, такой как GUID. Этот секрет определяется свойством **RegistrationKey** в метаконфигурации целевого узла.

### Пример метаконфигурации

```powershell
[DscLocalConfigurationManager()]
Configuration SampleMetaConfig
{
    Settings
    {
        RefreshMode = "PULL";
        AllowModuleOverwrite = $true;
        RebootNodeIfNeeded = $true;
        ConfigurationModeFrequencyMins = 60;
    }

    ConfigurationRepositoryWeb ConfigurationManager
    {
        ServerURL = “https://PullServerMachine:8080/psdscpullserver.svc”
        RegistrationKey = "140a952b-b9d6-406b-b416-e0f759c9c0e4"
        ConfigurationNames = @(“WebRole”)
    }
}

SampleMetaConfig
```

Значение RegistrationKey должно быть определено на опрашивающем сервере. Чтобы сделать это при настройке сервера, создайте текстовый файл с именем **RegistrationKeys.txt** в определенном расположении и укажите это расположение в файле web.config опрашивающего сервера, как показано ниже.  

```XML
<add key="ConfigurationPath" value="C:\Program Files\WindowsPowerShell\DscService\Configuration">

<add key="ModulePath" value="C:\Program Files\WindowsPowerShell\DscService\Modules">

<add key="RegistrationKeyPath" value="C:\Program Files\WindowsPowerShell\DscService">
```

Используйте последнюю версию ресурса xDSCWebService DSC, чтобы полностью развернуть локальный опрашивающий сервер для выполнения этой задачи. Полноценную конфигурацию см. в разделе [Пример конфигурации](https://github.com/grayzu/PSSummitEU2015/blob/master/PullServer/02%20-%20PullServer%20Config.ps1).

**Примечание.** Эта функция не поддерживается, когда опрашивающий сервер настроен в качестве общей папки. Она поддерживается только для опрашивающего веб-сервера.<!--HONumber=Mar16_HO2-->
