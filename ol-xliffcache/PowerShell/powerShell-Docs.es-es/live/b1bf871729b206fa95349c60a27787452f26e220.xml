{"nodes":[{"content":"Just Enough Administration (JEA): An Introduction","pos":[2,51]},{"content":"Table of Contents","pos":[56,73]},{"content":"After reading this document, you should be able to author, deploy, use, maintain, and audit a Just Enough Administration (JEA) deployment.","pos":[74,212]},{"content":"Here are the topics covered in this introductory guide:","pos":[213,268]},{"pos":[274,349],"content":"<bpt id=\"p1\">[</bpt>Introduction<ept id=\"p1\">](#introduction)</ept>: Briefly review why you should care about JEA"},{"pos":[355,411],"content":"<bpt id=\"p1\">[</bpt>Prerequisites<ept id=\"p1\">](#prerequisites)</ept>: Set up your environment"},{"pos":[417,501],"content":"<bpt id=\"p1\">[</bpt>Using JEA<ept id=\"p1\">](#using-jea)</ept>: Start by understanding the operator experience of using JEA"},{"pos":[507,600],"content":"<bpt id=\"p1\">[</bpt>Remake the Demo<ept id=\"p1\">](#remake-the-demo-endpoint)</ept>: Create a JEA Session Configuration from scratch"},{"pos":[606,719],"content":"<bpt id=\"p1\">[</bpt>Role Capabilities<ept id=\"p1\">](#role-capabilities)</ept>: Learn about how to customize JEA capabilities with Role Capability Files"},{"pos":[725,845],"content":"<bpt id=\"p1\">[</bpt>End to End - Active Directory<ept id=\"p1\">](#end-to-end---active-directory)</ept>: Make a whole new endpoint for managing Active Directory"},{"pos":[851,994],"content":"<bpt id=\"p1\">[</bpt>Multi-machine Deployment and Maintenance<ept id=\"p1\">](#multi-machine-deployment-and-maintenance)</ept>: Discover how deployment and authoring changes with scale"},{"pos":[1000,1109],"content":"<bpt id=\"p1\">[</bpt>Reporting on JEA<ept id=\"p1\">](#reporting-on-jea)</ept>: Discover how to audit and report on all JEA actions and infrastructure"},{"pos":[1115,1176],"content":"<bpt id=\"p1\">[</bpt>Appendix<ept id=\"p1\">](#appendix)</ept>: Important skills and discussion points"},{"content":"Introduction","pos":[1181,1193]},{"content":"Motivation","pos":[1199,1209]},{"content":"When you grant someone privileged access to your systems, you extend your trust boundary to that person.","pos":[1210,1314]},{"content":"This is a risk -- administrators are an attack surface.","pos":[1315,1370]},{"content":"Insider attacks and stolen credentials are both real and common.","pos":[1371,1435]},{"content":"This is not a new problem.","pos":[1437,1463]},{"content":"You are probably very familiar with the principle of least privilege, and you might use some form of role based access control (RBAC) with applications that provide it.","pos":[1464,1632]},{"content":"However, the effectiveness and manageability of these solutions are often limited by their broad scope and imprecision.","pos":[1633,1752]},{"content":"Furthermore, there are gaps in RBAC coverage.","pos":[1753,1798]},{"content":"For example, in Windows, privileged access is largely a binary switch, forcing you to give unnecessary permissions when adding users to the Administrators group.","pos":[1799,1960]},{"content":"Just Enough Administration (JEA) provides a RBAC platform through PowerShell Remoting.","pos":[1962,2048]},{"content":"It allows specific users to perform specific administrative tasks on servers without giving them administrator rights.","pos":[2050,2168]},{"content":"This allows you to fill in the gaps between your existing RBAC solutions, and simplifies management of those settings.","pos":[2170,2288]},{"content":"Prerequisites","pos":[2293,2306]},{"content":"Initial State","pos":[2312,2325]},{"content":"Before starting this section, please ensure the following:","pos":[2326,2384]},{"content":"JEA is available on your system.","pos":[2389,2421]},{"content":"Check out the <bpt id=\"p1\">[</bpt>README<ept id=\"p1\">](./README.md)</ept> for the current supported operating systems and required downloads.","pos":[2422,2525]},{"content":"You have administrative rights on the computer where you are trying out JEA.","pos":[2529,2605]},{"content":"The computer is domain joined.","pos":[2609,2639]},{"content":"See the <bpt id=\"p1\">[</bpt>Creating a Domain Controller<ept id=\"p1\">](#creating-a-domain-controller)</ept> section to quickly set up a new domain on a server if you don't already have one.","pos":[2640,2791]},{"content":"Enable PowerShell Remoting","pos":[2797,2823]},{"content":"Management with JEA occurs through PowerShell Remoting.","pos":[2824,2879]},{"content":"Run the following in an Administrator PowerShell window to ensure that this is enabled and configured properly:","pos":[2880,2991]},{"pos":[3031,3185],"content":"If you are unfamiliar with PowerShell remoting, it would be a good idea to run <ph id=\"ph1\">`Get-Help about_Remote`</ph> to learn about this important foundational concept."},{"content":"Identify Your Users or Groups","pos":[3191,3220]},{"content":"To show JEA in action, you need to identify the non-administrator users and groups you are going to use throughout this guide.","pos":[3221,3347]},{"content":"If you're using an existing domain, please identify or create some unprivileged users and groups.","pos":[3351,3448]},{"content":"You will give these non-administrators access to JEA.","pos":[3449,3502]},{"content":"Anytime you see the <ph id=\"ph1\">`$NonAdministrator`</ph> variable in a top of a script, assign it to your selected non-administrator users or groups.","pos":[3503,3635]},{"content":"If you created a new domain from scratch, it's much easier.","pos":[3638,3697]},{"content":"Please use the <bpt id=\"p1\">[</bpt>Set Up Users and Groups<ept id=\"p1\">](#set-up-users-and-groups)</ept> section in the appendix to create a non-administrator users and groups.","pos":[3698,3836]},{"content":"The default values of <ph id=\"ph1\">`$NonAdministrator`</ph> will be the groups created in that section.","pos":[3837,3922]},{"content":"Set Up Maintenance Role Capability File","pos":[3928,3967]},{"content":"Run the following commands in PowerShell to create the demo Role Capability file we will be using for the next section.","pos":[3968,4087]},{"content":"Later in this guide, you will learn about what this file does.","pos":[4088,4150]},{"content":"Create and Register Demo Session Configuration File","pos":[5039,5090]},{"content":"Run the following commands to create and register the demo Session Configuration file we will be using for the next section.","pos":[5091,5215]},{"content":"Later in this guide, you will learn about what this file does.","pos":[5216,5278]},{"content":"Enable PowerShell Module Logging (Optional)","pos":[6585,6628]},{"content":"The following steps enable logging for all PowerShell actions on your system.","pos":[6629,6706]},{"content":"You don't need to enable this for JEA to work, but it will be useful in the <bpt id=\"p1\">[</bpt>Reporting on JEA<ept id=\"p1\">](#reporting-on-jea)</ept> section.","pos":[6707,6829]},{"content":"Open the Local Group Policy Editor","pos":[6834,6868]},{"content":"Navigate to \"Computer Configuration\\Administrative Templates\\Windows Components\\Windows PowerShell\"","pos":[6872,6971]},{"content":"Double Click on \"Turn on Module Logging\"","pos":[6975,7015]},{"content":"Click \"Enabled\"","pos":[7019,7034]},{"content":"In the Options section, click on \"Show\" next to Module Names","pos":[7038,7098]},{"content":"Type \"*\" in the pop up window.","pos":[7102,7132]},{"content":"This means PowerShell will log commands from all modules.","pos":[7133,7190]},{"content":"Click OK and apply the policy","pos":[7194,7223]},{"content":"Note: you can also enable system-wide PowerShell transcription through Group Policy.","pos":[7225,7309]},{"content":"Congratulations, you have now configured your computer with the demo endpoint and are ready to get started with JEA!","pos":[7313,7429]},{"content":"Using JEA","pos":[7436,7445]},{"content":"This section focuses on understanding the end user experience of <bpt id=\"p1\">*</bpt>using JEA<ept id=\"p1\">*</ept>.","pos":[7446,7523]},{"content":"In the prerequisites section, you created a demo JEA endpoint.","pos":[7524,7586]},{"content":"We will use this demo to show JEA in action.","pos":[7587,7631]},{"content":"In later sections, the guide will work backwards -- introducing the actions and files that made that end-user experience possible.","pos":[7632,7762]},{"content":"Using JEA as a Non-Administrator","pos":[7768,7800]},{"content":"To show JEA in action, you will need to use PowerShell remoting as though you were a non-administrator user.","pos":[7801,7909]},{"content":"Run the following command in a new PowerShell window:","pos":[7910,7963]},{"content":"Enter the credentials for your non-administrator account when prompted.","pos":[8018,8089]},{"content":"If you followed the <bpt id=\"p1\">[</bpt>Set Up Users and Groups<ept id=\"p1\">](#set-up-users-and-groups)</ept> section, they will be:","pos":[8090,8184]},{"content":"Username = \"OperatorUser\"","pos":[8189,8214]},{"content":"Password = \"pa$$w0rd\"","pos":[8219,8240]},{"content":"Next, run the following command to connect to the demo endpoint using the credentials you provided:","pos":[8242,8341]},{"content":"You have now entered an interactive remote PowerShell session on the local machine.","pos":[8449,8532]},{"content":"By using the \"Credential\" parameter, you have connected <bpt id=\"p1\">*</bpt>as though you were<ept id=\"p1\">*</ept> OperatorUser (or whichever account you used).","pos":[8533,8656]},{"content":"The change in the prompt to <ph id=\"ph1\">`[localhost]: PS&gt;`</ph> indicates that you are operating against a remote session.","pos":[8657,8762]},{"content":"Run the following in your remote command prompt to show the commands available to you:","pos":[8766,8852]},{"content":"As you can tell, this is a very limited subset of the commands available in a normal PowerShell window (which can often include several thousand commands).","pos":[8886,9041]},{"content":"Specifically, it only shows the 7 default JEA cmdlets (Clear-Host, Exit-PSSession, Get-Command, Get-FormatData, Get-Help, Measure-Object, Out-Default, Select-Object) and the two commands explicitly included in the maintenance Role Capability file.","pos":[9042,9289]},{"content":"Next, let's take a look at the user context this session is operating under by invoking the custom function included in the maintenance Role Capability file:","pos":[9291,9448]},{"content":"The output of this function shows the \"ConnectedUser\" as well as the \"RunAsUser.\"","pos":[9483,9564]},{"content":"The connected user is the account that connected to the remote session (e.g. your account).","pos":[9565,9656]},{"content":"The connected user does not need to have administrator privileges.","pos":[9657,9723]},{"content":"The \"Run As\" account is the account actually performing the privileged actions.","pos":[9724,9803]},{"content":"By connecting as one user, and running as a privileged user, we allow non-privileged users to preform specific administrative tasks without giving them administrative rights.","pos":[9804,9978]},{"content":"To demonstrate this in action, run the following command:","pos":[9980,10037]},{"content":"Normally, Restart-Service requires administrator privileges to be run.","pos":[10097,10167]},{"content":"With the JEA virtual account, however, we're able to run it using non-privileged credentials.","pos":[10168,10261]},{"content":"So, JEA lets you get your job done using the commands you already use.","pos":[10263,10333]},{"content":"But what about commands you <bpt id=\"p1\">*</bpt>shouldn't<ept id=\"p1\">*</ept> be allowed to use?","pos":[10334,10392]},{"content":"Try running a different command in the JEA session, like <ph id=\"ph1\">`Restart-Computer`</ph>, and notice that JEA prevents such commands from being executed.","pos":[10393,10533]},{"content":"Finally, to leave the constrained JEA endpoint, run the following command:","pos":[10966,11040]},{"content":"This disconnects you from the remote PowerShell session.","pos":[11076,11132]},{"content":"Remake the Demo Endpoint","pos":[11137,11161]},{"content":"In this section, you will learn how to generate an exact replica of the demo endpoint you used in the above section.","pos":[11162,11278]},{"content":"This will introduce core concepts that are necessary to understand JEA, including PowerShell Session Configurations and Role Capabilities.","pos":[11279,11417]},{"content":"PowerShell Session Configurations","pos":[11424,11457]},{"content":"When you used JEA in the above section, you started by running the following command:","pos":[11458,11543]},{"content":"While most of the parameters are self-explanatory, the <bpt id=\"p1\">*</bpt>ConfigurationName<ept id=\"p1\">*</ept> parameter may seem confusing at first.","pos":[11650,11763]},{"content":"That parameter specified the PowerShell Session Configuration to which you were connecting.","pos":[11764,11855]},{"content":"<bpt id=\"p1\">*</bpt>PowerShell Session Configuration<ept id=\"p1\">*</ept> is a fancy term for a PowerShell endpoint.","pos":[11858,11935]},{"content":"It is the figurative \"place\" where users connect and get access to PowerShell functionality.","pos":[11936,12028]},{"content":"Based on how you set up a Session Configuration, it can provide different functionality to connecting users.","pos":[12029,12137]},{"content":"For JEA, we use Session Configurations to restrict PowerShell to a limited set of functionality and to run as a privileged virtual account.","pos":[12138,12277]},{"content":"You already have several registered PowerShell Session Configurations on your machine, each set up slightly differently.","pos":[12279,12399]},{"content":"Most of them come with Windows, but the \"JEA_Demo\" Session Configuration was set up in the <bpt id=\"p1\">[</bpt>prerequisites<ept id=\"p1\">](#prerequisites)</ept> section.","pos":[12400,12531]},{"content":"You can see all registered Session Configurations by running the following command in an Administrator PowerShell prompt:","pos":[12532,12653]},{"content":"PowerShell Session Configuration Files","pos":[12705,12743]},{"content":"You can make new Session Configurations by registering new <bpt id=\"p1\">*</bpt>PowerShell Session Configuration Files<ept id=\"p1\">*</ept>.","pos":[12744,12844]},{"content":"Session Configuration Files have \".pssc\" file extensions.","pos":[12845,12902]},{"content":"You can generate Session Configuration Files with the New-PSSessionConfigurationFile cmdlet.","pos":[12903,12995]},{"content":"Next, you are going to create and register a new Session Configuration for JEA.","pos":[12997,13076]},{"content":"Generate and Modify your PowerShell Session Configuration","pos":[13083,13140]},{"content":"Run the following command to generate a PowerShell Session Configuration \"skeleton\" file.","pos":[13141,13230]},{"pos":[13340,13524],"content":"**TIP:** Only the most common configuration settings are included in the skeleton file by default.\nUse the `-Full` parameter to include all applicable settings in the generated PSSC.","leadings":["","> "],"nodes":[{"content":"<bpt id=\"p1\">**</bpt>TIP:<ept id=\"p1\">**</ept> Only the most common configuration settings are included in the skeleton file by default.","pos":[0,98]},{"content":"Use the <ph id=\"ph1\">`-Full`</ph> parameter to include all applicable settings in the generated PSSC.","pos":[99,182]}]},{"content":"Open the file in PowerShell ISE, or your favorite text editor.","pos":[13526,13588]},{"content":"Update the following fields in the file with the values below (remember to substitue in your own non-administrator security group):","pos":[13664,13795]},{"content":"Here is what each of those entries mean:","pos":[14324,14364]},{"content":"The <bpt id=\"p1\">*</bpt>SessionType<ept id=\"p1\">*</ept> field defines preset default settings to use with this endpoint.","pos":[14370,14452]},{"content":"<bpt id=\"p1\">*</bpt>RestrictedRemoteServer<ept id=\"p1\">*</ept> defines the minimal settings necessary for remote management.","pos":[14453,14539]},{"content":"By default, a <bpt id=\"p1\">*</bpt>RestrictedRemoteServer<ept id=\"p1\">*</ept> endpoint will expose Get-Command, Get-FormatData, Select-Object, Get-Help, Measure-Object, Exit-PSSession, Clear-Host, and Out-Default.","pos":[14540,14715]},{"content":"It will set the <bpt id=\"p1\">*</bpt>ExecutionPolicy<ept id=\"p1\">*</ept> to <bpt id=\"p2\">*</bpt>RemoteSigned<ept id=\"p2\">*</ept>, and the <bpt id=\"p3\">*</bpt>LanguageMode<ept id=\"p3\">*</ept> to <bpt id=\"p4\">*</bpt>NoLanguage<ept id=\"p4\">*</ept>.","pos":[14716,14808]},{"content":"The net effect of these settings is a secure and minimal starting point for configuring your endpoint.","pos":[14809,14911]},{"content":"The <bpt id=\"p1\">*</bpt>RoleDefinitions<ept id=\"p1\">*</ept> field assigns Role Capabilities to specific groups.","pos":[14917,14990]},{"content":"It defines who can do what as a privileged account.","pos":[14991,15042]},{"content":"With this field, you can specify the functionality available to any connecting user based on group membership.","pos":[15043,15153]},{"content":"This is the core of JEA's RBAC functionality.","pos":[15154,15199]},{"content":"In this example, you are exposing the pre-made \"Demo\" RoleCapability to members of the \"Contoso\\JEA_NonAdmin_Operator\" group.","pos":[15200,15325]},{"content":"The <bpt id=\"p1\">*</bpt>RunAsVirtualAccount<ept id=\"p1\">*</ept> field indicates that PowerShell should \"run as\" a Virtual Account at this endpoint.","pos":[15331,15440]},{"content":"By default, the Virtual Account is a member of the built in Administrators group.","pos":[15441,15522]},{"content":"On a domain controller, it is also a member of the Domain Administrators group by default.","pos":[15523,15613]},{"content":"Later in this guide, you will learn how to customize the privileges of the Virtual Account.","pos":[15614,15705]},{"content":"The <bpt id=\"p1\">*</bpt>TranscriptDirectory<ept id=\"p1\">*</ept> field defines where \"over-the-shoulder\" PowerShell transcripts are saved after each remote session.","pos":[15711,15836]},{"content":"These transcripts allow you to inspect the actions taken in each session in a readable way.","pos":[15837,15928]},{"content":"For more information about PowerShell transcripts, check out this <bpt id=\"p1\">[</bpt>blog post<ept id=\"p1\">](http://blogs.msdn.com/b/powershell/archive/2015/06/09/powershell-the-blue-team.aspx)</ept>.","pos":[15929,16092]},{"content":"Note: regular Windows Eventing also captures information about what each user ran with PowerShell.","pos":[16093,16191]},{"content":"Transcripts are just a bit more readable.","pos":[16192,16233]},{"pos":[16235,16281],"content":"Finally, save your changes to <bpt id=\"p1\">*</bpt>JEADemo2.pssc<ept id=\"p1\">*</ept>."},{"content":"Apply the PowerShell Session Configuration","pos":[16287,16329]},{"content":"To create an endpoint from a Session Configuration file, you need to register the file.","pos":[16332,16419]},{"content":"This requires a few pieces of information:","pos":[16420,16462]},{"content":"The path to the Session Configuration file.","pos":[16467,16510]},{"content":"The name of your registered Session Configuration.","pos":[16514,16564]},{"content":"This is the same name users provide to the \"ConfigurationName\" parameter when they connect to your endpoint with <ph id=\"ph1\">`Enter-PSSession`</ph> or <ph id=\"ph2\">`New-PSSession`</ph>.","pos":[16565,16715]},{"content":"To register the Session Configuration on your local machine, run the following command:","pos":[16717,16804]},{"content":"Congratulations!","pos":[16930,16946]},{"content":"You have set up your JEA endpoint.","pos":[16947,16981]},{"content":"Test Out Your Endpoint","pos":[16987,17009]},{"content":"Re-run the steps listed in the <bpt id=\"p1\">[</bpt>Using JEA<ept id=\"p1\">](#using-jea)</ept> section against your new endpoint to confirm it is operating as intended.","pos":[17010,17138]},{"content":"Be sure to use the new endpoint name (JEADemo2) when providing the configuration name to Enter-PSSession.","pos":[17139,17244]},{"content":"Key Concepts","pos":[17355,17367]},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Session Configuration<ept id=\"p1\">**</ept>: Sometimes referred to as <bpt id=\"p2\">*</bpt>PowerShell Endpoint<ept id=\"p2\">*</ept>, this is the figurative \"place\" where users connect and get access to PowerShell functionality.","pos":[17368,17548]},{"content":"You can list the registered Session Configurations on your system by running <ph id=\"ph1\">`Get-PSSessionConfiguration`</ph>.","pos":[17549,17655]},{"content":"When configured in a specific way, a PowerShell Session Configuration can be called a <bpt id=\"p1\">*</bpt>JEA Endpoint<ept id=\"p1\">*</ept>.","pos":[17656,17757]},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Session Configuration File (.pssc)<ept id=\"p1\">**</ept>: A file that, when registered, defines settings for a PowerShell Session Configuration.","pos":[17759,17896]},{"content":"It contains specifications for user roles that can connect to the endpoint, the \"run as\" Virtual Account, and more.","pos":[17897,18012]},{"content":"<bpt id=\"p1\">**</bpt>Role Definitions<ept id=\"p1\">**</ept>: The field in a Session Configuration File that defines the Role Capabilities granted to connecting users.","pos":[18019,18146]},{"content":"It defines <bpt id=\"p1\">*</bpt>who<ept id=\"p1\">*</ept> can do <bpt id=\"p2\">*</bpt>what<ept id=\"p2\">*</ept> as a privileged account.","pos":[18147,18202]},{"content":"This is the core of JEA's RBAC capabilities.","pos":[18203,18247]},{"content":"<bpt id=\"p1\">**</bpt>SessionType<ept id=\"p1\">**</ept>: A field in a Session Configuration File that represents default settings for a Session Configuration.","pos":[18249,18367]},{"content":"For JEA endpoints, this must be set to RestrictedRemoteServer.","pos":[18368,18430]},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Transcript<ept id=\"p1\">**</ept>: A file containing an \"over-the-shoulder\" view of a PowerShell session.","pos":[18432,18529]},{"content":"You can set PowerShell to generate transcripts for JEA sessions using the TranscriptDirectory field.","pos":[18530,18630]},{"content":"For more information on transcripts, check out this <bpt id=\"p1\">[</bpt>blog post<ept id=\"p1\">](https://technet.microsoft.com/en-us/magazine/ff687007.aspx)</ept>.","pos":[18631,18755]},{"content":"Role Capabilities","pos":[18760,18777]},{"content":"Overview","pos":[18783,18791]},{"content":"In the above section, you learned that the \"RoleDefinitions\" field defined which groups had access to which Role Capabilities.","pos":[18792,18918]},{"content":"You may have wondered, \"What are Role Capabilities?\"","pos":[18919,18971]},{"content":"This section will answer that question.","pos":[18972,19011]},{"content":"Introducing PowerShell Role Capabilities","pos":[19018,19058]},{"content":"PowerShell Role Capabilities define \"what\" a user can do at a JEA endpoint.","pos":[19059,19134]},{"content":"They detail a whitelist of things like visible commands, visible applications, and more.","pos":[19135,19223]},{"content":"Role Capabilities are defined by files with a \".psrc\" extension.","pos":[19224,19288]},{"content":"Role Capability Contents","pos":[19293,19317]},{"content":"We will start by examining and modifying the demo Role Capability file you used before.","pos":[19318,19405]},{"content":"Imagine you have deployed your Session Configuration across your environment, but you have gotten feedback that you need to change the capabilities exposed to users.","pos":[19406,19571]},{"content":"Operators need the ability to restart machines, and they also want to be able to get information about network settings.","pos":[19572,19692]},{"content":"In addition, the security team has told you that allowing users to run \"Restart-Service\" without any restrictions is not acceptable.","pos":[19693,19825]},{"content":"You need to restrict the services that operators can restart.","pos":[19826,19887]},{"content":"To make these changes, start by running PowerShell ISE as an Administrator and open the following file:","pos":[19889,19992]},{"content":"Now find and update the following lines in the file:","pos":[20092,20144]},{"content":"This contains a few interesting examples:","pos":[20555,20596]},{"content":"You have restricted Restart-Service such that operators will only be able to use Restart-Service with the -Name parameter, and they will only be allowed to provide \"Spooler\" as an argument to that parameter.","pos":[20602,20809]},{"content":"If you wanted to, you could also restrict the arguments using a regular expression using \"ValidatePattern\" instead of \"ValidateSet\".","pos":[20810,20942]},{"content":"You have exposed all commands with the \"Get\" verb from the NetTCPIP module.","pos":[20948,21023]},{"content":"Because \"Get\" commands typically don't change system state, this is a relatively safe action.","pos":[21024,21117]},{"content":"That being said, it is strongly encouraged to closely examinine every command you expose through JEA.","pos":[21118,21219]},{"content":"You have expose an executable (ipconfig) using VisibleExternalCommands.","pos":[21225,21296]},{"content":"You can also expose full PowerShell scripts with this field.","pos":[21297,21357]},{"content":"It is important to always provide the full path to external commands to ensure a similarly named (and potentially malicous) program placed in the user's path does not get executed instead.","pos":[21358,21546]},{"content":"Save the file, then connect to the demo endpoint again to confirm the changes worked.","pos":[21548,21633]},{"content":"Because you only modified the Role Capability file, you do not need to re-register the Session Configuration.","pos":[21751,21860]},{"content":"PowerShell will automatically find your updated Role Capability when a user connects.","pos":[21861,21946]},{"content":"Since Role Capabilities are loaded when the session starts, existing sessions are not affected by updates to Role Capability files.","pos":[21947,22078]},{"content":"Now, confirm that you can restart the computer by running Restart-Computer with the -WhatIf parameter (unless you actually want to restart the computer).","pos":[22080,22233]},{"content":"Confirm that you can run \"ipconfig\"","pos":[22280,22315]},{"content":"And finally, confirm that Restart-Service only works for the Spooler service.","pos":[22345,22422]},{"content":"Exit the session when you are finished.","pos":[22530,22569]},{"content":"Role Capability Creation","pos":[22610,22634]},{"content":"In the next section, you will create a JEA endpoint for AD help desk users.","pos":[22635,22710]},{"content":"To prepare, we will create a blank Role Capability file to fill in for that section.","pos":[22711,22795]},{"content":"Role Capabilities must be created inside a \"RoleCapabilities\" folder inside a valid PowerShell module in order to be resolved when a session starts.","pos":[22796,22944]},{"content":"PowerShell Modules are essentially packages of PowerShell functionality.","pos":[22946,23018]},{"content":"They can contain PowerShell functions, cmdlets, DSC Resources, Role Capabilities, and more.","pos":[23019,23110]},{"content":"You can find information about modules by running <ph id=\"ph1\">`Get-Help about_Modules`</ph> in a PowerShell console.","pos":[23111,23210]},{"content":"To create a new PowerShell module with a blank Role Capability file, run the following commands:","pos":[23212,23308]},{"content":"Congratulations, you have created a blank Role Capability File.","pos":[24439,24502]},{"content":"It will be used in the next section.","pos":[24503,24539]},{"content":"Key Concepts","pos":[24545,24557]},{"content":"<bpt id=\"p1\">**</bpt>Role Capability (.psrc)<ept id=\"p1\">**</ept>: A file that define \"what\" a user can do at a JEA endpoint.","pos":[24558,24645]},{"content":"It details a whitelist of things like visible commands, visible console applications, and more.","pos":[24646,24741]},{"content":"In order for PowerShell to detect Role Capabilities, you must put them in a \"RoleCapabilities\" folder in a valid PowerShell module.","pos":[24742,24873]},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Module<ept id=\"p1\">**</ept>: A package of PowerShell functionality.","pos":[24875,24936]},{"content":"It can contain PowerShell functions, cmdlets, DSC Resources, Role Capabilities, and more.","pos":[24937,25026]},{"content":"In order to be automatically loaded, PowerShell modules must be located under a path in <ph id=\"ph1\">`$env:PSModulePath`</ph>.","pos":[25027,25135]},{"content":"End to End - Active Directory","pos":[25141,25170]},{"content":"Imagine the scope of your program has increased.","pos":[25171,25219]},{"content":"You are now responsible for adding JEA to Domain Controllers to perform Active Directory actions.","pos":[25220,25317]},{"content":"The help desk people are going to use JEA to unlock accounts, reset passwords, and do other similar actions.","pos":[25318,25426]},{"content":"You need to expose a completely new set of commands to a different group of people.","pos":[25428,25511]},{"content":"On top of that, you have a bunch of existing Active Directory scripts you need to expose.","pos":[25512,25601]},{"content":"This section will walk through authoring a Session Configuration and Role Capability for this task.","pos":[25602,25701]},{"content":"Prerequisites","pos":[25707,25720]},{"content":"To follow this section step-by-step, you'll need to be operating on a domain controller.","pos":[25721,25809]},{"content":"If you don't have access to your domain controller, don't worry.","pos":[25810,25874]},{"content":"Try to follow along with by working against some other scenario or role with which you are familiar.","pos":[25875,25975]},{"content":"If you want to quickly set up a new domain controller, check out the <bpt id=\"p1\">[</bpt>Creating a Domain Controller appendix<ept id=\"p1\">](#creating-a-domain-controller)</ept>.","pos":[25976,26116]},{"content":"Steps to Make a new Role Capability and Session Configuration","pos":[26122,26183]},{"content":"Making a new role capability can seem daunting at first, but it can be broken into fairly simple steps:","pos":[26185,26288]},{"content":"Identify the tasks you need to enable","pos":[26294,26331]},{"content":"Restrict those tasks as necessary","pos":[26336,26369]},{"content":"Confirm they work with JEA","pos":[26374,26400]},{"content":"Put them in a Role Capability file","pos":[26405,26439]},{"content":"Register a Session Configuration that exposes that Role Capability","pos":[26444,26510]},{"content":"Step 1: Identify What Needs to Be Exposed","pos":[26516,26557]},{"content":"Before you make a new Role Capability or Session Configuration, you need to identify all of the things users will need to do through the JEA endpoint, as well as how to do them through PowerShell.","pos":[26558,26754]},{"content":"This will involve a fair amount of requirement gathering and research.","pos":[26755,26825]},{"content":"How you go about this process will depend on your organization and goals.","pos":[26826,26899]},{"content":"It is important to call out requirement gathering and research as a critical part of the real world process.","pos":[26900,27008]},{"content":"This may be the most difficult step in the process of adopting JEA.","pos":[27009,27076]},{"content":"Find Resources","pos":[27083,27097]},{"content":"Here is a set of online resources that might have come up in your research on creating an Active Directory management endpoint:","pos":[27098,27225]},{"content":"Active Directory PowerShell Overview","pos":[27231,27267]},{"content":"CMD to PowerShell Guide for Active Directory","pos":[27374,27418]},{"content":"Make a List","pos":[27537,27548]},{"content":"Here is a set of ten actions that you will be working from in the remainder of this section.","pos":[27549,27641]},{"content":"Keep in mind this is simply an example, your organizations requirements may be different:","pos":[27642,27731]},{"content":"Action","pos":[27734,27740]},{"content":"PowerShell Command","pos":[27798,27816]},{"content":"Account Unlock","pos":[27994,28008]},{"content":"Password Reset","pos":[28124,28138]},{"pos":[28212,28215],"content":"and"},{"content":"Change a User's Title","pos":[28254,28275]},{"content":"Find AD Accounts that are locked out, disabled, inactive, etc.","pos":[28386,28448]},{"content":"Add User to Group","pos":[28517,28534]},{"content":"Remove User from Group","pos":[28648,28670]},{"content":"Enable a user account","pos":[28779,28800]},{"content":"Disable a user account","pos":[28909,28931]},{"content":"Step 2: Restrict Tasks as Necessary","pos":[29043,29078]},{"content":"Now that you have your list of actions, you need to think through the capabilities of each command.","pos":[29080,29179]},{"content":"There are two important reasons to do this:","pos":[29180,29223]},{"content":"It is easy to expose give users more capabilities than you intend.","pos":[29229,29295]},{"content":"For example, <ph id=\"ph1\">`Set-ADUser`</ph> is an incredibly powerful and flexible command.","pos":[29296,29369]},{"content":"You may not want to expose everything it can do to help desk users.","pos":[29370,29437]},{"content":"Even worse, it's possible to expose commands that allow users to escape JEA's restrictions.","pos":[29445,29536]},{"content":"If this happens, JEA ceases to function as a security boundary.","pos":[29537,29600]},{"content":"Please be careful when selecting commands.","pos":[29601,29643]},{"content":"For example, Invoke-Expression will allow users to run unrestricted code.","pos":[29644,29717]},{"content":"For more discussion on this topic, check out the Considerations When Restricting Commands section.","pos":[29718,29816]},{"content":"After reviewing each command, you decide to restrict the following:","pos":[29818,29885]},{"pos":[29904,29961],"content":"should only be allowed to run with the \"-Title\" parameter"},{"pos":[29988,30051],"content":"and <ph id=\"ph1\">`Remove-ADGroupMember`</ph> should only work with certain groups"},{"content":"Step 3: Confirm the Tasks Work with JEA","pos":[30057,30096]},{"content":"Actually using those cmdlets may not be straightforward in the restricted JEA environment.","pos":[30097,30187]},{"content":"JEA runs in <bpt id=\"p1\">*</bpt>No Language<ept id=\"p1\">*</ept> mode which, among other things, prevents users from using variables.","pos":[30188,30282]},{"content":"In order to ensure that end users have a smooth experience, it's important to check for a few things.","pos":[30283,30384]},{"content":"As an example, consider <ph id=\"ph1\">`Set-ADAccountPassword`</ph>.","pos":[30386,30434]},{"content":"The \"-NewPassword\" parameter requires a secure string.","pos":[30435,30489]},{"content":"Often, users create a secure string and pass it in as a variable (as below):","pos":[30490,30566]},{"content":"However, No Language mode prevents the usage of variables.","pos":[30735,30793]},{"content":"You can get around this restriction in two ways:","pos":[30794,30842]},{"content":"You can require users run the command without assigning variables.","pos":[30848,30914]},{"content":"This is easy to configure, but can be painful for the operators using the endpoint.","pos":[30915,30998]},{"content":"Who wants to type this out every time you reset a password?","pos":[30999,31058]},{"content":"You can wrap the complexity in a script or a function that you expose to end users.","pos":[31202,31285]},{"content":"Scripts and functions that you expose run in an unrestricted context; you can write functions that use variables and call other commands without any issue.","pos":[31286,31441]},{"content":"This approach simplifies the end user experience, prevents errors, reduces required PowerShell knowledge, and reduces unintentionally exposing excess functionality.","pos":[31442,31606]},{"content":"The only downside is the cost of authoring and maintaining the function.","pos":[31607,31679]},{"content":"Aside: Adding a Function to your Module","pos":[31686,31725]},{"content":"Taking approach #2, you are going to write a PowerShell function called <ph id=\"ph1\">`Reset-ContosoUserPassword`</ph>.","pos":[31726,31826]},{"content":"This function is going to do everything that needs to happen when you reset a user's password.","pos":[31827,31921]},{"content":"In your organization, this may involve doing fancy and complicated things.","pos":[31922,31996]},{"content":"Because this is just an example, your command will just reset the password and require the user change the password at logon.","pos":[31997,32122]},{"content":"We will put it in the Contoso_AD_Module module you made in the last section.","pos":[32123,32199]},{"content":"In PowerShell ISE, open \"Contoso_AD_Module.psm1\"","pos":[32204,32252]},{"content":"Press Crtl+J to open the snippets menu.","pos":[32366,32405]},{"content":"Key down until you find \"function\" and press enter.","pos":[32410,32461]},{"content":"This puts up a super basic skeleton of a function.","pos":[32462,32512]},{"content":"Rename the function \"Reset-ContosoUserPassword\".","pos":[32517,32565]},{"content":"Rename one of the parameters \"Identity\" and delete the second.","pos":[32572,32634]},{"content":"Copy the following into the body of the function.","pos":[32639,32688]},{"content":"Save the file.","pos":[32998,33012]},{"content":"You should end up with something that looks like this:","pos":[33013,33067]},{"pos":[33425,33554],"content":"Now, your users can simply call <ph id=\"ph1\">`Reset-ContosoUserPassword`</ph> and not have to remember the syntax to create a secure string inline."},{"content":"Step 4: Edit the Role Capability File","pos":[33560,33597]},{"content":"In the <bpt id=\"p1\">[</bpt>Role Capability Creation<ept id=\"p1\">](#role-capability-creation)</ept> section, you created a blank Role Capability file.","pos":[33598,33709]},{"content":"In this section, you will fill in the values in that file.","pos":[33710,33768]},{"content":"Start by opening the role capability file in ISE.","pos":[33770,33819]},{"content":"Update the file with the following changes:","pos":[33939,33982]},{"content":"There are a few things to note about the above:","pos":[34933,34980]},{"content":"PowerShell will attempt to auto-load the modules needed for your Role Capability.","pos":[34985,35066]},{"content":"You may need to explicitly list module names in the \"ModulesToImport\" field if you notice problems with a module not being autoloaded.","pos":[35067,35201]},{"pos":[35207,35313],"content":"If you aren't sure if a command is a cmdlet or a function, run <ph id=\"ph1\">`Get-Command`</ph> and look at the \"CommandType\""},{"content":"The ValidatePattern allows you to use a regular expression to restrict parameter arguments if it is not easy to define a set of allowable values.","pos":[35319,35464]},{"content":"You cannot define both a ValidatePattern and ValidateSet for a single parameter.","pos":[35465,35545]},{"content":"Step 5: Register a new Session Configuration","pos":[35551,35595]},{"content":"Next, you will create a new session configuration file that will expose your Role Capability to members of the \"JEA_NonAdmin_HelpDesk\" AD group.","pos":[35596,35740]},{"content":"Start by creating and opening a new blank Session Configuration file in PowerShell ISE.","pos":[35743,35830]},{"content":"Modify the following fields in the PSSC file.","pos":[35999,36044]},{"content":"If you are working in your own environment, you should replace \"CONTOSO\\JEA_NonAdmins_Helpdesk\" with your own non-administrator user or group.","pos":[36045,36187]},{"content":"Save and register the Session Configuration","pos":[36794,36837]},{"content":"Test It Out!","pos":[36970,36982]},{"content":"Get your non-administrator user credentials:","pos":[36983,37027]},{"content":"If you followed the Set Up Users and Groups section, the credentials will be:","pos":[37077,37154]},{"content":"Username = \"HelpDeskUser\"","pos":[37159,37184]},{"content":"Password = \"pa$$w0rd\"","pos":[37189,37210]},{"content":"Remote into the AD Helpdesk endpoint using the non-admin credential:","pos":[37212,37280]},{"content":"Use Set-ADUser to reset a user's title.","pos":[37388,37427]},{"content":"Verify that the title has changed.","pos":[37497,37531]},{"content":"Now, use Add-ADGroupMember to add a user to the TestGroup.","pos":[37601,37659]},{"content":"Note: make sure you've created the TestGroup beforehand.","pos":[37660,37716]},{"content":"Exit the session:","pos":[37794,37811]},{"content":"Key Concepts","pos":[37849,37861]},{"content":"<bpt id=\"p1\">**</bpt>NoLanguage Mode<ept id=\"p1\">**</ept>: When PowerShell is in \"NoLanguage\" mode, users may only run commands; they cannot use any language elements.","pos":[37862,37991]},{"content":"For more information, run <ph id=\"ph1\">`Get-Help about_Language_Modes`</ph>.","pos":[37992,38050]},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Functions<ept id=\"p1\">**</ept>: PowerShell functions are bits of PowerShell code that you can call by name.","pos":[38052,38153]},{"content":"For more information, run <ph id=\"ph1\">`Get-Help about_Functions`</ph>.","pos":[38154,38207]},{"content":"<bpt id=\"p1\">**</bpt>ValidateSet/ValidatePattern<ept id=\"p1\">**</ept>: When exposing a command, you can restrict valid arguments for specific parameters.","pos":[38209,38324]},{"content":"A ValidateSet is a specific list of valid commands.","pos":[38325,38376]},{"content":"A ValidatePattern is a regular expression that the arguments for that parameter must match.","pos":[38377,38468]},{"content":"Multi-machine Deployment and Maintenance","pos":[38473,38513]},{"content":"At this point, you have deployed JEA to local systems several times.","pos":[38514,38582]},{"content":"Because your production environment probably consists of more than one machine, it's important to walk through the critical steps in the deployment process that must be repeated on each machine.","pos":[38583,38777]},{"content":"High Level Steps:","pos":[38783,38800]},{"content":"Copy your modules (with Role Capabilities) to each node.","pos":[38805,38861]},{"content":"Copy your session configuration files to each node.","pos":[38866,38917]},{"pos":[38922,38992],"content":"Run <ph id=\"ph1\">`Register-PSSessionConfiguration`</ph> with your session configuration."},{"content":"Keep a copy of your session configuration and toolkits in a secure location.","pos":[38997,39073]},{"content":"As you make modifications, it's good to have a \"single source of truth.\"","pos":[39074,39146]},{"content":"Example Script","pos":[39152,39166]},{"content":"Here's an example script for deployment.","pos":[39167,39207]},{"content":"To use it in your environment, you'll have to use the names/paths of real file shares and modules.","pos":[39208,39306]},{"content":"Modifying Capabilities","pos":[41001,41023]},{"content":"When dealing with many machines, it's important that modifications are rolled out in a consistent manner.","pos":[41024,41129]},{"content":"Once JEA has a DSC Resource, this will help ensure your environment is in sync.","pos":[41130,41209]},{"content":"Until that time, we highly recommend you keep a master copy of your session configurations and re-deploy each time you make a modification.","pos":[41210,41349]},{"content":"Removing Capabilities","pos":[41355,41376]},{"content":"To remove your JEA configuration from your systems, use the following command on each machine:","pos":[41377,41471]},{"content":"Reporting on JEA","pos":[41542,41558]},{"content":"Because JEA allows non-privileged users to run in a privileged context, logging and auditing are extremely important.","pos":[41559,41676]},{"content":"In this section, we'll run through the tools you can use to help you with logging and reporting.","pos":[41677,41773]},{"content":"Reporting on JEA Actions","pos":[41779,41803]},{"content":"Over-the-Shoulder Transcription","pos":[41809,41840]},{"content":"One of the quickest ways to get a summary of what's happening in a PowerShell session is to look over the shoulder of the person typing.","pos":[41841,41977]},{"content":"You see their commands, the output of those commands, and all is well.","pos":[41978,42048]},{"content":"Or it's not, but at least you'll know.","pos":[42049,42087]},{"content":"PowerShell transcription is designed to give you a similar view after the fact.","pos":[42088,42167]},{"content":"When using the \"TranscriptDirectory\" field in your Session Configuration, PowerShell will automatically record a transcript of all actions taken in a given session.","pos":[42169,42333]},{"content":"You can find transcripts from your sessions in this document here: \"$env:ProgramData\\JEAConfiguration\\Transcripts\"","pos":[42334,42448]},{"content":"As you can tell, the transcript records information about the \"Connected\" user, the \"Run As\" user, the commands run in the session, and more.","pos":[42450,42591]},{"content":"For more information about PowerShell transcription, check out <bpt id=\"p1\">[</bpt>this blog post<ept id=\"p1\">](http://blogs.msdn.com/b/powershell/archive/2015/06/09/powershell-the-blue-team.aspx)</ept>.","pos":[42592,42757]},{"content":"PowerShell Event Logs","pos":[42764,42785]},{"content":"When you have module logging turned on, all PowerShell actions are also recorded in regular Windows Event logs.","pos":[42786,42897]},{"content":"This is slightly messier to deal with when compared to transcripts, but the level of detail it gives you can be useful.","pos":[42898,43017]},{"content":"In the \"PowerShell\" operational log, Event ID 4104 will record each command invoked if you have enabled module logging.","pos":[43019,43138]},{"content":"Other Event Logs","pos":[43145,43161]},{"content":"Unlike PowerShell logs and transcripts, other logging mechanisms will not capture the \"Connected User\".","pos":[43162,43265]},{"content":"You will need to do some correlation between other logs and PowerShell logs to match up actions taken.","pos":[43266,43368]},{"content":"In the \"Windows Remote Management\" operational log, Event ID 193 will record the Connecting User's SID and Name, as well as the RunAs Virtual Account's SID to assist with this correlation.","pos":[43370,43558]},{"content":"You may have also noticed that the name of the RunAs Virtual Account includes the connecting user's domain and username at the end.","pos":[43559,43690]},{"content":"Reporting on JEA Configuration","pos":[43696,43726]},{"content":"Get-PSSessionConfiguration","pos":[43732,43758]},{"content":"In order to accurately report on the state of your environment, it's important to know how many JEA endpoints you have set up on your machine.","pos":[43759,43901]},{"content":"does just that.","pos":[43931,43946]},{"content":"Get-PSSessionCapability","pos":[43954,43977]},{"content":"Manually reporting on the capabilities of any given user through a JEA endpoint can be quite complex.","pos":[43978,44079]},{"content":"You would potentially need to inspect several role capabilities.","pos":[44080,44144]},{"content":"Fortunately, the \"Get-PSSessionCapability\" cmdlet does this.","pos":[44145,44205]},{"content":"To test this out, run the following command from an administrator PowerShell prompt:","pos":[44207,44291]},{"content":"Conclusion","pos":[44397,44407]},{"content":"After completing this guide, you should have the tools and vocabulary to create your own JEA endpoint.","pos":[44409,44511]},{"content":"Thanks for reading!","pos":[44512,44531]},{"content":"Appendix","pos":[44536,44544]},{"content":"Key Concepts Used Throughout This Guide","pos":[44549,44588]},{"content":"<bpt id=\"p1\">**</bpt>PowerShell Remoting<ept id=\"p1\">**</ept>: PowerShell remoting allows you to run PowerShell commands against remote machines.","pos":[44589,44696]},{"content":"You can operate against one or many computers, and use either temporary or persistent connections.","pos":[44697,44795]},{"content":"In this demo, you remoted into your local machine with an interactive session.","pos":[44796,44874]},{"content":"JEA restricts the functionality available through PowerShell remoting.","pos":[44875,44945]},{"content":"For more information about PowerShell remoting, run <ph id=\"ph1\">`Get-Help about_Remote`</ph>.","pos":[44946,45022]},{"content":"<bpt id=\"p1\">**</bpt>\"RunAs\" User<ept id=\"p1\">**</ept>: When using JEA, a non-administrator \"runs as\" a privileged \"Virtual Account.\"","pos":[45024,45119]},{"content":"The Virtual Account only lasts the duration of the remote session.","pos":[45120,45186]},{"content":"That is to say, it is created when a user connects to the endpoint, and destroyed when the user ends the session.","pos":[45187,45300]},{"content":"By default, the Virtual Account is a member of the local Administrators group.","pos":[45301,45379]},{"content":"On a domain controller, it is a member of Domain Admins.","pos":[45380,45436]},{"content":"Virtual Accounts are local to the machine on which they are created, and do not have permissions outside of that machine.","pos":[45437,45558]},{"content":"This means that they are not registered in Active Directory (no RID is assigned).","pos":[45559,45640]},{"content":"Additionally, if an allowed command/script tries to access resources outside of the local machine, it will be accessing those resources under the machine's identity, not the Virtual Account identity.","pos":[45641,45840]},{"content":"<bpt id=\"p1\">**</bpt>\"Connected\" User<ept id=\"p1\">**</ept>: The non-administrator user who connects to the JEA endpoint and to whom roles are assigned.","pos":[45842,45955]},{"content":"Any commands this user runs are run under the context of the RunAs User or virtual account.","pos":[45956,46047]},{"content":"Creating a Domain Controller","pos":[46054,46082]},{"content":"This document assumes that your machine is domain joined.","pos":[46084,46141]},{"content":"If you currently don't have a domain to join, this section can help you quickly stand up a domain controller using DSC.","pos":[46142,46261]},{"content":"Prerequisites","pos":[46268,46281]},{"content":"The machine is on an internal network","pos":[46287,46324]},{"content":"The machine is not joined to an existing domain","pos":[46329,46376]},{"content":"The machine is running Windows Server 2016 or has WMF 5.0 installed","pos":[46381,46448]},{"content":"Install xActiveDirectory","pos":[46455,46479]},{"content":"If your machine has an active internet connection, run the following command in an elevated PowerShell window:","pos":[46480,46590]},{"content":"If you do not have an internet connection, install xActiveDirectory to another machine and then copy the xActiveDirectory folder to the \"C:\\Program Files\\WindowsPowerShell\\Modules\" folder on your machine.","pos":[46649,46853]},{"content":"To confirm the installation succeeded, run the following command:","pos":[46855,46920]},{"content":"Set up a domain with DSC","pos":[46989,47013]},{"content":"Copy the following script in PowerShell to make your machine a Domain Controller in a new domain.","pos":[47014,47111]},{"content":"AUTHOR'S NOTE: THERE IS A KNOWN ISSUE WITH THE CREDENTIALS PROVIDED NOT BEING USED.","pos":[47114,47197]},{"content":"TO BE SAFE, DON'T FORGET YOUR LOCAL ADMIN PASSWORD.","pos":[47199,47250]},{"content":"Your machine will restart a few times.","pos":[49053,49091]},{"content":"You will know the process is complete once you see a file called \"C:\\temp.txt\" containing \"Domain has been created.\"","pos":[49092,49208]},{"content":"Set up Users and Groups","pos":[49216,49239]},{"content":"The following commands will set up an Operator and Helpdesk group in your domain and a corresponding non-administrator user who is a member of that group.","pos":[49240,49394]},{"content":"On Blacklisting","pos":[50246,50261]},{"content":"After playing around with JEA, you may be wondering if it is possible to blacklist commands.","pos":[50262,50354]},{"content":"This is an understandable request, but it is not currently planned for JEA for the following reasons:","pos":[50355,50456]},{"content":"We designed JEA to limit operators to only the actions they need to do.","pos":[50462,50533]},{"content":"A blacklist is the opposite.","pos":[50534,50562]},{"content":"PowerShell command authors did not design PowerShell commands with the JEA in mind.","pos":[50568,50651]},{"content":"On a fresh install of Windows Server 2016, there are about 1520 commands immediately available.","pos":[50652,50747]},{"content":"The threat models for these commands did not include the possibility that a user would be running commands as a more privileged account.","pos":[50748,50884]},{"content":"For example, certain commands allow for code injection by design (e.g. Add-Type and Invoke-Command in the core PowerShell module).","pos":[50885,51015]},{"content":"JEA can warn you when you expose the specific commands we know about, but we have not re-assessed every other command in Windows based on the new threat model.","pos":[51016,51175]},{"content":"You must understand the capabilities of the commands you exposing through JEA.","pos":[51176,51254]},{"content":"Furthermore, even if JEA blocked all commands with code-injection vulnerabilities, there is no guarantee that a malicious user would not be able to carry out a blacklisted action with another related command.","pos":[51262,51470]},{"content":"Unless you understand all of the commands that you are exposing, it is impossible for you to guarantee that a certain action is not possible.","pos":[51471,51612]},{"content":"The burden is on you to understand what commands you are exposing, whether they are using a whitelist or a blacklist.","pos":[51613,51730]},{"content":"The number of commands a blacklist would expose is unmanageable, so JEA is implemented using whitelists instead.","pos":[51731,51843]},{"content":"Considerations When Limiting Commands","pos":[51849,51886]},{"content":"There is one important point to make about this step.","pos":[51887,51940]},{"content":"It is critical that all capabilities exposed through JEA are located in administrator-restricted areas.","pos":[51941,52044]},{"content":"Non-administrator users should not have the capability to modify the scripts used through JEA endpoints.","pos":[52045,52149]},{"content":"On a related note, it is critical that you do not give JEA users the ability to overwrite JEA configurations and whitelisted scripts within their JEA sessions.","pos":[52151,52310]},{"content":"Be extremely careful when exposing commands like <ph id=\"ph1\">`Copy-Item`</ph>!","pos":[52311,52372]},{"content":"Common Role Capability Pitfalls","pos":[52378,52409]},{"content":"You may run into a few common pitfalls into you go through this process yourself.","pos":[52410,52491]},{"content":"Here is a quick guide explaining how to identify and remediate these issues when modifying or creating a new endpoint:","pos":[52492,52610]},{"content":"Functions vs. Cmdlets","pos":[52617,52638]},{"content":"PowerShell commands written in PowerShell are PowerShell Functions.","pos":[52639,52706]},{"content":"PowerShell commands written as specialized .NET classes are PowerShell Cmdlets.","pos":[52707,52786]},{"content":"You can check the command type by running <ph id=\"ph1\">`Get-Command`</ph>.","pos":[52787,52843]},{"content":"VisibleProviders","pos":[52850,52866]},{"content":"You will need to expose any providers your commands need.","pos":[52868,52925]},{"content":"The most common is the FileSystem provider, but you may also need to expose others, like the Registry provider.","pos":[52926,53037]},{"content":"For an introduction to providers, check out this <bpt id=\"p1\">[</bpt>Hey, Scripting Guy blog post<ept id=\"p1\">](http://blogs.technet.com/b/heyscriptingguy/archive/2015/04/20/find-and-use-windows-powershell-providers.aspx)</ept>.","pos":[53038,53228]},{"content":"Be careful when exposing providers -- often, it is better to define your own function that works with the underlying providers than to directly expose the provider in a JEA session.","pos":[53229,53410]},{"content":"This way, you can still allow users to work with files, registry keys, etc. but retain control over *<bpt id=\"p1\">*</bpt>which<ept id=\"p1\">*</ept> files and registry keys they can work with using custom validation logic.","pos":[53411,53593]}],"content":"# Just Enough Administration (JEA): An Introduction\n\n## Table of Contents\nAfter reading this document, you should be able to author, deploy, use, maintain, and audit a Just Enough Administration (JEA) deployment.\nHere are the topics covered in this introductory guide:\n\n1.  [Introduction](#introduction): Briefly review why you should care about JEA\n\n2.  [Prerequisites](#prerequisites): Set up your environment\n\n3.  [Using JEA](#using-jea): Start by understanding the operator experience of using JEA\n\n4.  [Remake the Demo](#remake-the-demo-endpoint): Create a JEA Session Configuration from scratch\n\n5.  [Role Capabilities](#role-capabilities): Learn about how to customize JEA capabilities with Role Capability Files\n\n6.  [End to End - Active Directory](#end-to-end---active-directory): Make a whole new endpoint for managing Active Directory\n\n7.  [Multi-machine Deployment and Maintenance](#multi-machine-deployment-and-maintenance): Discover how deployment and authoring changes with scale\n\n8.  [Reporting on JEA](#reporting-on-jea): Discover how to audit and report on all JEA actions and infrastructure\n\n9.  [Appendix](#appendix): Important skills and discussion points\n\n## Introduction\n\n### Motivation\nWhen you grant someone privileged access to your systems, you extend your trust boundary to that person.\nThis is a risk -- administrators are an attack surface.\nInsider attacks and stolen credentials are both real and common.\n\nThis is not a new problem.\nYou are probably very familiar with the principle of least privilege, and you might use some form of role based access control (RBAC) with applications that provide it.\nHowever, the effectiveness and manageability of these solutions are often limited by their broad scope and imprecision.\nFurthermore, there are gaps in RBAC coverage.\nFor example, in Windows, privileged access is largely a binary switch, forcing you to give unnecessary permissions when adding users to the Administrators group.\n\nJust Enough Administration (JEA) provides a RBAC platform through PowerShell Remoting.\n*It allows specific users to perform specific administrative tasks on servers without giving them administrator rights.*\nThis allows you to fill in the gaps between your existing RBAC solutions, and simplifies management of those settings.\n\n## Prerequisites\n\n### Initial State\nBefore starting this section, please ensure the following:\n\n1. JEA is available on your system. Check out the [README](./README.md) for the current supported operating systems and required downloads.\n2. You have administrative rights on the computer where you are trying out JEA.\n3. The computer is domain joined.\nSee the [Creating a Domain Controller](#creating-a-domain-controller) section to quickly set up a new domain on a server if you don't already have one.\n\n### Enable PowerShell Remoting\nManagement with JEA occurs through PowerShell Remoting.\nRun the following in an Administrator PowerShell window to ensure that this is enabled and configured properly:\n\n```PowerShell\nEnable-PSRemoting \n```\n\nIf you are unfamiliar with PowerShell remoting, it would be a good idea to run `Get-Help about_Remote` to learn about this important foundational concept.\n\n### Identify Your Users or Groups\nTo show JEA in action, you need to identify the non-administrator users and groups you are going to use throughout this guide.\n  \nIf you're using an existing domain, please identify or create some unprivileged users and groups.\nYou will give these non-administrators access to JEA.\nAnytime you see the `$NonAdministrator` variable in a top of a script, assign it to your selected non-administrator users or groups. \n\nIf you created a new domain from scratch, it's much easier.\nPlease use the [Set Up Users and Groups](#set-up-users-and-groups) section in the appendix to create a non-administrator users and groups.\nThe default values of `$NonAdministrator` will be the groups created in that section.\n\n### Set Up Maintenance Role Capability File\nRun the following commands in PowerShell to create the demo Role Capability file we will be using for the next section.\nLater in this guide, you will learn about what this file does.\n\n```PowerShell\n# Fields in the role capability\n$MaintenanceRoleCapabilityCreationParams = @{\n    Author = 'Contoso Admin'\n    CompanyName = 'Contoso'\n    VisibleCmdlets = 'Restart-Service'\n    FunctionDefinitions = \n            @{ Name = 'Get-UserInfo'; ScriptBlock = { $PSSenderInfo } }\n}\n\n# Create the demo module, which will contain the maintenance Role Capability File\nNew-Item -Path \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\Demo_Module\" -ItemType Directory\nNew-ModuleManifest -Path \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\Demo_Module\\Demo_Module.psd1\"\nNew-Item -Path \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\Demo_Module\\RoleCapabilities\" -ItemType Directory \n\n# Create the Role Capability file\nNew-PSRoleCapabilityFile -Path \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\Demo_Module\\RoleCapabilities\\Maintenance.psrc\" @MaintenanceRoleCapabilityCreationParams \n```\n  \n### Create and Register Demo Session Configuration File\nRun the following commands to create and register the demo Session Configuration file we will be using for the next section.\nLater in this guide, you will learn about what this file does.\n\n```PowerShell\n# Determine domain\n$domain = (Get-CimInstance -ClassName Win32_ComputerSystem).Domain\n\n# Replace with your non-admin group name\n$NonAdministrator = \"$domain\\JEA_NonAdmin_Operator\"\n\n# Specify the settings for this JEA endpoint\n# Note: You will not be able to use a virtual account if you are using WMF 5.0 on Windows 7 or Windows Server 2008 R2\n$JEAConfigParams = @{\n    SessionType = 'RestrictedRemoteServer'\n    RunAsVirtualAccount = $true\n    RoleDefinitions = @{\n        $NonAdministrator = @{ RoleCapabilities = 'Maintenance' }\n    }\n    TranscriptDirectory = \"$env:ProgramData\\JEAConfiguration\\Transcripts\"\n}\n\n# Set up a folder for the Session Configuration files\nif (-not (Test-Path \"$env:ProgramData\\JEAConfiguration\"))\n{\n    New-Item -Path \"$env:ProgramData\\JEAConfiguration\" -ItemType Directory\n}\n\n# Specify the name of the JEA endpoint\n$sessionName = 'JEA_Demo'\n\nif (Get-PSSessionConfiguration -Name $sessionName -ErrorAction SilentlyContinue)\n{\n    Unregister-PSSessionConfiguration -Name $sessionName -ErrorAction Stop\n}\n\nNew-PSSessionConfigurationFile -Path \"$env:ProgramData\\JEAConfiguration\\JEADemo.pssc\" @JEAConfigParams\n\n# Register the session configuration\nRegister-PSSessionConfiguration -Name $sessionName -Path \"$env:ProgramData\\JEAConfiguration\\JEADemo.pssc\"\n```\n \n### Enable PowerShell Module Logging (Optional)\nThe following steps enable logging for all PowerShell actions on your system.\nYou don't need to enable this for JEA to work, but it will be useful in the [Reporting on JEA](#reporting-on-jea) section.\n\n1. Open the Local Group Policy Editor\n2. Navigate to \"Computer Configuration\\Administrative Templates\\Windows Components\\Windows PowerShell\"\n3. Double Click on \"Turn on Module Logging\"\n4. Click \"Enabled\"\n5. In the Options section, click on \"Show\" next to Module Names\n6. Type \"*\" in the pop up window. This means PowerShell will log commands from all modules.\n7. Click OK and apply the policy\n\nNote: you can also enable system-wide PowerShell transcription through Group Policy.\n\n**Congratulations, you have now configured your computer with the demo endpoint and are ready to get started with JEA!**\n\n## Using JEA\nThis section focuses on understanding the end user experience of *using JEA*.\nIn the prerequisites section, you created a demo JEA endpoint.\nWe will use this demo to show JEA in action.\nIn later sections, the guide will work backwards -- introducing the actions and files that made that end-user experience possible.\n\n### Using JEA as a Non-Administrator\nTo show JEA in action, you will need to use PowerShell remoting as though you were a non-administrator user.\nRun the following command in a new PowerShell window:   \n\n```PowerShell\n$NonAdminCred = Get-Credential\n```\n\nEnter the credentials for your non-administrator account when prompted.\nIf you followed the [Set Up Users and Groups](#set-up-users-and-groups) section, they will be:\n-   Username = \"OperatorUser\"\n-   Password = \"pa$$w0rd\"\n\nNext, run the following command to connect to the demo endpoint using the credentials you provided:\n\n```PowerShell\nEnter-PSSession -ComputerName . -ConfigurationName JEA_Demo -Credential $NonAdminCred \n```\n\nYou have now entered an interactive remote PowerShell session on the local machine. \nBy using the \"Credential\" parameter, you have connected *as though you were* OperatorUser (or whichever account you used).\nThe change in the prompt to `[localhost]: PS>` indicates that you are operating against a remote session.  \n\nRun the following in your remote command prompt to show the commands available to you:\n\n```PowerShell\nGet-Command \n```\n\nAs you can tell, this is a very limited subset of the commands available in a normal PowerShell window (which can often include several thousand commands).\nSpecifically, it only shows the 7 default JEA cmdlets (Clear-Host, Exit-PSSession, Get-Command, Get-FormatData, Get-Help, Measure-Object, Out-Default, Select-Object) and the two commands explicitly included in the maintenance Role Capability file.\n\nNext, let's take a look at the user context this session is operating under by invoking the custom function included in the maintenance Role Capability file:\n\n```PowerShell\nGet-UserInfo\n```\n \nThe output of this function shows the \"ConnectedUser\" as well as the \"RunAsUser.\"\nThe connected user is the account that connected to the remote session (e.g. your account).\nThe connected user does not need to have administrator privileges.\nThe \"Run As\" account is the account actually performing the privileged actions.\nBy connecting as one user, and running as a privileged user, we allow non-privileged users to preform specific administrative tasks without giving them administrative rights.\n\nTo demonstrate this in action, run the following command:\n\n```PowerShell\nRestart-Service -Name Spooler -Verbose\n```\n\nNormally, Restart-Service requires administrator privileges to be run.\nWith the JEA virtual account, however, we're able to run it using non-privileged credentials.\n\nSo, JEA lets you get your job done using the commands you already use.\nBut what about commands you *shouldn't* be allowed to use?\nTry running a different command in the JEA session, like `Restart-Computer`, and notice that JEA prevents such commands from being executed.\n\n```PowerShell\n[localhost]: PS> Restart-Computer\nThe term 'Restart-Computer' is not recognized as the name of a cmdlet, function, script file, or\noperable program. Check the spelling of the name, or if a path was included, verify that the path\nis correct and try again.\n    + CategoryInfo          : ObjectNotFound: (Restart-Computer:String) [], CommandNotFoundException\n    + FullyQualifiedErrorId : CommandNotFoundException \n```\n\nFinally, to leave the constrained JEA endpoint, run the following command:\n\n```PowerShell\nExit-PSSession\n```\n\nThis disconnects you from the remote PowerShell session.\n\n## Remake the Demo Endpoint\nIn this section, you will learn how to generate an exact replica of the demo endpoint you used in the above section.\nThis will introduce core concepts that are necessary to understand JEA, including PowerShell Session Configurations and Role Capabilities. \n\n### PowerShell Session Configurations\nWhen you used JEA in the above section, you started by running the following command:\n\n```PowerShell\nEnter-PSSession -ComputerName . -ConfigurationName JEA_Demo -Credential $NonAdminCred\n```\n\nWhile most of the parameters are self-explanatory, the *ConfigurationName* parameter may seem confusing at first.\nThat parameter specified the PowerShell Session Configuration to which you were connecting. \n\n*PowerShell Session Configuration* is a fancy term for a PowerShell endpoint.\nIt is the figurative \"place\" where users connect and get access to PowerShell functionality.\nBased on how you set up a Session Configuration, it can provide different functionality to connecting users.\nFor JEA, we use Session Configurations to restrict PowerShell to a limited set of functionality and to run as a privileged virtual account.\n\nYou already have several registered PowerShell Session Configurations on your machine, each set up slightly differently.\nMost of them come with Windows, but the \"JEA_Demo\" Session Configuration was set up in the [prerequisites](#prerequisites) section.\nYou can see all registered Session Configurations by running the following command in an Administrator PowerShell prompt:\n\n```PowerShell\nGet-PSSessionConfiguration\n```\n\n### PowerShell Session Configuration Files\nYou can make new Session Configurations by registering new *PowerShell Session Configuration Files*.\nSession Configuration Files have \".pssc\" file extensions.\nYou can generate Session Configuration Files with the New-PSSessionConfigurationFile cmdlet.\n\nNext, you are going to create and register a new Session Configuration for JEA. \n\n### Generate and Modify your PowerShell Session Configuration\nRun the following command to generate a PowerShell Session Configuration \"skeleton\" file.\n\n```PowerShell\nNew-PSSessionConfigurationFile -Path \"$env:ProgramData\\JEAConfiguration\\JEADemo2.pssc\"\n```\n\n> **TIP:** Only the most common configuration settings are included in the skeleton file by default.\n> Use the `-Full` parameter to include all applicable settings in the generated PSSC.\n\nOpen the file in PowerShell ISE, or your favorite text editor.\n\n```PowerShell\nise \"$env:ProgramData\\JEAConfiguration\\JEADemo2.pssc\" \n```\n\nUpdate the following fields in the file with the values below (remember to substitue in your own non-administrator security group): \n\n```PowerShell\n# OLD: SessionType = 'Default'\nSessionType = 'RestrictedRemoteServer'\n\n# OLD: TranscriptDirectory = 'C:\\Transcripts\\'\nTranscriptDirectory = \"C:\\ProgramData\\JEAConfiguration\\Transcripts\"\n\n# OLD: # RunAsVirtualAccount = $true\nRunAsVirtualAccount = $true\n\n# OLD: RoleDefinitions = @{ 'CONTOSO\\SqlAdmins' = @{ RoleCapabilities = 'SqlAdministration' }; 'CONTOSO\\ServerMonitors' = @{ VisibleCmdlets = 'Get-Process' } }\nRoleDefinitions = @{'CONTOSO\\JEA_NonAdmin_Operator' = @{ RoleCapabilities =  'Maintenance' }}\n```\n\nHere is what each of those entries mean:\n\n1.  The *SessionType* field defines preset default settings to use with this endpoint.\n*RestrictedRemoteServer* defines the minimal settings necessary for remote management. \nBy default, a *RestrictedRemoteServer* endpoint will expose Get-Command, Get-FormatData, Select-Object, Get-Help, Measure-Object, Exit-PSSession, Clear-Host, and Out-Default.\nIt will set the *ExecutionPolicy* to *RemoteSigned*, and the *LanguageMode* to *NoLanguage*.\nThe net effect of these settings is a secure and minimal starting point for configuring your endpoint.\n\n2.  The *RoleDefinitions* field assigns Role Capabilities to specific groups.\nIt defines who can do what as a privileged account.\nWith this field, you can specify the functionality available to any connecting user based on group membership.\nThis is the core of JEA's RBAC functionality.\nIn this example, you are exposing the pre-made \"Demo\" RoleCapability to members of the \"Contoso\\JEA_NonAdmin_Operator\" group.\n\n3.  The *RunAsVirtualAccount* field indicates that PowerShell should \"run as\" a Virtual Account at this endpoint.\nBy default, the Virtual Account is a member of the built in Administrators group.\nOn a domain controller, it is also a member of the Domain Administrators group by default.\nLater in this guide, you will learn how to customize the privileges of the Virtual Account.\n\n4.  The *TranscriptDirectory* field defines where \"over-the-shoulder\" PowerShell transcripts are saved after each remote session.\nThese transcripts allow you to inspect the actions taken in each session in a readable way.\nFor more information about PowerShell transcripts, check out this [blog post](http://blogs.msdn.com/b/powershell/archive/2015/06/09/powershell-the-blue-team.aspx).\nNote: regular Windows Eventing also captures information about what each user ran with PowerShell.\nTranscripts are just a bit more readable.\n\nFinally, save your changes to *JEADemo2.pssc*.\n\n### Apply the PowerShell Session Configuration \n\nTo create an endpoint from a Session Configuration file, you need to register the file.\nThis requires a few pieces of information:\n\n1. The path to the Session Configuration file.\n2. The name of your registered Session Configuration. This is the same name users provide to the \"ConfigurationName\" parameter when they connect to your endpoint with `Enter-PSSession` or `New-PSSession`.\n\nTo register the Session Configuration on your local machine, run the following command:\n\n```PowerShell\nRegister-PSSessionConfiguration -Name 'JEADemo2' -Path \"$env:ProgramData\\JEAConfiguration\\JEADemo2.pssc\"\n```\n\nCongratulations! You have set up your JEA endpoint.\n\n### Test Out Your Endpoint\nRe-run the steps listed in the [Using JEA](#using-jea) section against your new endpoint to confirm it is operating as intended.\nBe sure to use the new endpoint name (JEADemo2) when providing the configuration name to Enter-PSSession.\n\n```PowerShell\nEnter-PSSession -ComputerName . -ConfigurationName JEADemo2 -Credential $NonAdminCred\n```\n\n### Key Concepts\n**PowerShell Session Configuration**:\nSometimes referred to as *PowerShell Endpoint*, this is the figurative \"place\" where users connect and get access to PowerShell functionality.\nYou can list the registered Session Configurations on your system by running `Get-PSSessionConfiguration`.\nWhen configured in a specific way, a PowerShell Session Configuration can be called a *JEA Endpoint*.\n\n**PowerShell Session Configuration File (.pssc)**:\nA file that, when registered, defines settings for a PowerShell Session Configuration.\nIt contains specifications for user roles that can connect to the endpoint, the \"run as\" Virtual Account, and more.     \n\n**Role Definitions**:\nThe field in a Session Configuration File that defines the Role Capabilities granted to connecting users.\nIt defines *who* can do *what* as a privileged account.\nThis is the core of JEA's RBAC capabilities.\n\n**SessionType**:\nA field in a Session Configuration File that represents default settings for a Session Configuration.\nFor JEA endpoints, this must be set to RestrictedRemoteServer.\n\n**PowerShell Transcript**:\nA file containing an \"over-the-shoulder\" view of a PowerShell session.\nYou can set PowerShell to generate transcripts for JEA sessions using the TranscriptDirectory field.\nFor more information on transcripts, check out this [blog post](https://technet.microsoft.com/en-us/magazine/ff687007.aspx).\n\n## Role Capabilities\n\n### Overview\nIn the above section, you learned that the \"RoleDefinitions\" field defined which groups had access to which Role Capabilities.\nYou may have wondered, \"What are Role Capabilities?\"\nThis section will answer that question.  \n\n## Introducing PowerShell Role Capabilities\nPowerShell Role Capabilities define \"what\" a user can do at a JEA endpoint.\nThey detail a whitelist of things like visible commands, visible applications, and more.\nRole Capabilities are defined by files with a \".psrc\" extension.\n\n## Role Capability Contents\nWe will start by examining and modifying the demo Role Capability file you used before.\nImagine you have deployed your Session Configuration across your environment, but you have gotten feedback that you need to change the capabilities exposed to users.\nOperators need the ability to restart machines, and they also want to be able to get information about network settings.\nIn addition, the security team has told you that allowing users to run \"Restart-Service\" without any restrictions is not acceptable.\nYou need to restrict the services that operators can restart.\n\nTo make these changes, start by running PowerShell ISE as an Administrator and open the following file:\n\n```\nC:\\Program Files\\WindowsPowerShell\\Modules\\Demo_Module\\RoleCapabilities\\Maintenance.psrc\n```\n\nNow find and update the following lines in the file: \n\n```PowerShell\n# OLD: VisibleCmdlets = 'Restart-Service'\nVisibleCmdlets = 'Restart-Computer',\n                 @{\n                     Name = 'Restart-Service'\n                     Parameters = @{ Name = 'Name'; ValidateSet = 'Spooler' }\n                 },\n                 'NetTCPIP\\Get-*'\n\n# OLD: VisibleExternalCommands = 'Item1', 'Item2'\nVisibleExternalCommands = 'C:\\Windows\\system32\\ipconfig.exe'\n```\n\nThis contains a few interesting examples:\n\n1.  You have restricted Restart-Service such that operators will only be able to use Restart-Service with the -Name parameter, and they will only be allowed to provide \"Spooler\" as an argument to that parameter.\nIf you wanted to, you could also restrict the arguments using a regular expression using \"ValidatePattern\" instead of \"ValidateSet\".\n\n2.  You have exposed all commands with the \"Get\" verb from the NetTCPIP module.\nBecause \"Get\" commands typically don't change system state, this is a relatively safe action.\nThat being said, it is strongly encouraged to closely examinine every command you expose through JEA.\n\n3.  You have expose an executable (ipconfig) using VisibleExternalCommands.\nYou can also expose full PowerShell scripts with this field.\nIt is important to always provide the full path to external commands to ensure a similarly named (and potentially malicous) program placed in the user's path does not get executed instead.\n\nSave the file, then connect to the demo endpoint again to confirm the changes worked.\n\n```PowerShell\nEnter-PSSession -ComputerName . -ConfigurationName JEADemo2 -Credential $NonAdminCred\nGet-Command\n```\nBecause you only modified the Role Capability file, you do not need to re-register the Session Configuration.\nPowerShell will automatically find your updated Role Capability when a user connects.\nSince Role Capabilities are loaded when the session starts, existing sessions are not affected by updates to Role Capability files.\n\nNow, confirm that you can restart the computer by running Restart-Computer with the -WhatIf parameter (unless you actually want to restart the computer).\n\n```PowerShell\nRestart-Computer -WhatIf \n```\n\nConfirm that you can run \"ipconfig\"\n\n```PowerShell\nipconfig\n```\n\nAnd finally, confirm that Restart-Service only works for the Spooler service.\n\n```PowerShell\nRestart-Service Spooler # This should work\nRestart-Service WSearch # This should fail \n```\n\nExit the session when you are finished.\n\n```PowerShell\nExit-PSSession \n```\n\n### Role Capability Creation\nIn the next section, you will create a JEA endpoint for AD help desk users.\nTo prepare, we will create a blank Role Capability file to fill in for that section.\nRole Capabilities must be created inside a \"RoleCapabilities\" folder inside a valid PowerShell module in order to be resolved when a session starts.\n\nPowerShell Modules are essentially packages of PowerShell functionality.\nThey can contain PowerShell functions, cmdlets, DSC Resources, Role Capabilities, and more.\nYou can find information about modules by running `Get-Help about_Modules` in a PowerShell console.\n\nTo create a new PowerShell module with a blank Role Capability file, run the following commands:  \n\n```PowerShell\n# Create a new folder for the module.\nNew-Item -Path 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module' -ItemType Directory\n\n# Add a module manifest to contain metadata for this module.\nNew-ModuleManifest -Path 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\Contoso_AD_Module.psd1' -RootModule Contoso_AD_Module.psm1\n\n# Create a blank script module. You'll use this for custom functions in the next section.\nNew-Item -Path 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\Contoso_AD_Module.psm1' -ItemType File \n\n# Create a RoleCapabilities folder in the AD_Module folder. PowerShell expects Role Capabilities to be located in a \"RoleCapabilities\" folder within a module.\nNew-Item -Path 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\RoleCapabilities' -ItemType Directory\n\n# Create a blank Role Capability in your RoleCapabilities folder. Running this command without any additional parameters just creates a blank template.\nNew-PSRoleCapabilityFile -Path 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\RoleCapabilities\\ADHelpDesk.psrc' \n```\n\nCongratulations, you have created a blank Role Capability File.\nIt will be used in the next section.\n\n### Key Concepts\n**Role Capability (.psrc)**:\nA file that define \"what\" a user can do at a JEA endpoint.\nIt details a whitelist of things like visible commands, visible console applications, and more.\nIn order for PowerShell to detect Role Capabilities, you must put them in a \"RoleCapabilities\" folder in a valid PowerShell module.\n\n**PowerShell Module**:\nA package of PowerShell functionality.\nIt can contain PowerShell functions, cmdlets, DSC Resources, Role Capabilities, and more.\nIn order to be automatically loaded, PowerShell modules must be located under a path in `$env:PSModulePath`. \n\n## End to End - Active Directory\nImagine the scope of your program has increased.\nYou are now responsible for adding JEA to Domain Controllers to perform Active Directory actions.\nThe help desk people are going to use JEA to unlock accounts, reset passwords, and do other similar actions.\n\nYou need to expose a completely new set of commands to a different group of people.\nOn top of that, you have a bunch of existing Active Directory scripts you need to expose.\nThis section will walk through authoring a Session Configuration and Role Capability for this task.\n\n### Prerequisites\nTo follow this section step-by-step, you'll need to be operating on a domain controller.\nIf you don't have access to your domain controller, don't worry.\nTry to follow along with by working against some other scenario or role with which you are familiar.\nIf you want to quickly set up a new domain controller, check out the [Creating a Domain Controller appendix](#creating-a-domain-controller).\n\n### Steps to Make a new Role Capability and Session Configuration\n\nMaking a new role capability can seem daunting at first, but it can be broken into fairly simple steps:\n\n1.  Identify the tasks you need to enable\n2.  Restrict those tasks as necessary\n3.  Confirm they work with JEA\n4.  Put them in a Role Capability file\n5.  Register a Session Configuration that exposes that Role Capability\n\n### Step 1: Identify What Needs to Be Exposed\nBefore you make a new Role Capability or Session Configuration, you need to identify all of the things users will need to do through the JEA endpoint, as well as how to do them through PowerShell.\nThis will involve a fair amount of requirement gathering and research.\nHow you go about this process will depend on your organization and goals.\nIt is important to call out requirement gathering and research as a critical part of the real world process.\nThis may be the most difficult step in the process of adopting JEA.\n\n#### Find Resources\nHere is a set of online resources that might have come up in your research on creating an Active Directory management endpoint:\n-   [Active Directory PowerShell Overview](http://blogs.msdn.com/b/adpowershell/archive/2009/03/05/active-directory-powershell-overview.aspx) \n-   [CMD to PowerShell Guide for Active Directory](http://blogs.technet.com/b/ashleymcglone/archive/2013/01/02/free-download-cmd-to-powershell-guide-for-ad.aspx)\n\n#### Make a List\nHere is a set of ten actions that you will be working from in the remainder of this section.\nKeep in mind this is simply an example, your organizations requirements may be different:\n\n|Action                                                         |PowerShell Command                                             |\n|---------------------------------------------------------------|---------------------------------------------------------------|\n|Account Unlock                                                 |`Unlock-ADAccount`                                             |\n|Password Reset                                                 |`Set-ADAccountPassword` and `Set-ADUser -ChangePasswordAtLogon`|\n|Change a User's Title                                          |`Set-ADUser -Title`                                            |  \n|Find AD Accounts that are locked out, disabled, inactive, etc. |`Search-ADAccount`                                             | \n|Add User to Group                                              |`Add-ADGroupMember -Identity (with whitelist) -Members`        | \n|Remove User from Group                                         |`Remove-ADGroupMember -Identity (with whitelist) -Members`     | \n|Enable a user account                                          |`Enable-ADAccount`                                             |\n|Disable a user account                                         |`Disable-ADAccount`                                            |\n\n### Step 2: Restrict Tasks as Necessary\n\nNow that you have your list of actions, you need to think through the capabilities of each command.\nThere are two important reasons to do this:\n\n1.  It is easy to expose give users more capabilities than you intend.\nFor example, `Set-ADUser` is an incredibly powerful and flexible command.\nYou may not want to expose everything it can do to help desk users.  \n\n2.  Even worse, it's possible to expose commands that allow users to escape JEA's restrictions.\nIf this happens, JEA ceases to function as a security boundary.\nPlease be careful when selecting commands.\nFor example, Invoke-Expression will allow users to run unrestricted code.\nFor more discussion on this topic, check out the Considerations When Restricting Commands section.\n\nAfter reviewing each command, you decide to restrict the following:\n\n1.  `Set-ADUser` should only be allowed to run with the \"-Title\" parameter \n\n2.  `Add-ADGroupMember` and `Remove-ADGroupMember` should only work with certain groups\n\n### Step 3: Confirm the Tasks Work with JEA\nActually using those cmdlets may not be straightforward in the restricted JEA environment.\nJEA runs in *No Language* mode which, among other things, prevents users from using variables.\nIn order to ensure that end users have a smooth experience, it's important to check for a few things.\n\nAs an example, consider `Set-ADAccountPassword`.\nThe \"-NewPassword\" parameter requires a secure string.\nOften, users create a secure string and pass it in as a variable (as below):\n\n```PowerShell\n$newPassword = (Read-Host -Prompt \"Specify a new password\" -AsSecureString)\nSet-ADAccountPassword -Identity mollyd -NewPassword $newPassword -Reset\n```\n\nHowever, No Language mode prevents the usage of variables.\nYou can get around this restriction in two ways:\n\n1.  You can require users run the command without assigning variables.\nThis is easy to configure, but can be painful for the operators using the endpoint.\nWho wants to type this out every time you reset a password?\n```PowerShell\nSet-ADAccountPassword -Identity mollyd -NewPassword (Read-Host -Prompt \"Specify a new password\" -AsSecureString) -Reset\n```\n\n2.  You can wrap the complexity in a script or a function that you expose to end users.\nScripts and functions that you expose run in an unrestricted context; you can write functions that use variables and call other commands without any issue.\nThis approach simplifies the end user experience, prevents errors, reduces required PowerShell knowledge, and reduces unintentionally exposing excess functionality.\nThe only downside is the cost of authoring and maintaining the function.\n\n#### Aside: Adding a Function to your Module\nTaking approach #2, you are going to write a PowerShell function called `Reset-ContosoUserPassword`.\nThis function is going to do everything that needs to happen when you reset a user's password.\nIn your organization, this may involve doing fancy and complicated things.\nBecause this is just an example, your command will just reset the password and require the user change the password at logon.\nWe will put it in the Contoso_AD_Module module you made in the last section.\n\n1. In PowerShell ISE, open \"Contoso_AD_Module.psm1\"\n```PowerShell\nISE 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\Contoso_AD_Module.psm1' \n```\n\n2. Press Crtl+J to open the snippets menu.\n\n3. Key down until you find \"function\" and press enter.\nThis puts up a super basic skeleton of a function.\n\n4. Rename the function \"Reset-ContosoUserPassword\".  \n\n5. Rename one of the parameters \"Identity\" and delete the second.\n\n6. Copy the following into the body of the function.\n```PowerShell\n# Get the new password\n$NewPassword = Read-Host -Prompt \"Enter a new password\" -AsSecureString\n# Reset the password\nSet-ADAccountPassword -Identity $Identity -NewPassword $NewPassword -Reset\n# Require the user to reset at next logon\nSet-ADUser -Identity $Identity -ChangePasswordAtLogon\n```\n\n7. Save the file.\nYou should end up with something that looks like this:\n```PowerShell\nfunction Reset-ContosoUserPassword ($Identity)\n{\n# Get the new password\n$NewPassword = Read-Host -Prompt \"Enter a new password\" -AsSecureString\n# Reset the password\nSet-ADAccountPassword -Identity $Identity -NewPassword $NewPassword -Reset\n# Require the user to reset at next logon\nSet-ADUser -Identity $Identity -ChangePasswordAtLogon\n} \n```\nNow, your users can simply call `Reset-ContosoUserPassword` and not have to remember the syntax to create a secure string inline.\n\n### Step 4: Edit the Role Capability File\nIn the [Role Capability Creation](#role-capability-creation) section, you created a blank Role Capability file.\nIn this section, you will fill in the values in that file.\n\nStart by opening the role capability file in ISE.\n```PowerShell\nise 'C:\\Program Files\\WindowsPowerShell\\Modules\\Contoso_AD_Module\\RoleCapabilities\\ADHelpDesk.psrc' \n```\nUpdate the file with the following changes:\n```PowerShell\n# OLD: VisibleCmdlets = 'Invoke-Cmdlet1', @{ Name = 'Invoke-Cmdlet2'; Parameters = @{ Name = 'Parameter1'; ValidateSet = 'Item1', 'Item2' }, @{ Name = 'Parameter2'; ValidatePattern = 'L*' } }\nVisibleCmdlets =\n    'Unlock-ADAccount',\n    'Search-ADAccount',\n    'Enable-ADAccount',\n    'Disable-ADAccount',\n    @{ Name = 'Set-ADUser'; Parameters = @{ Name = 'Title'; ValidateSet = 'Manager', 'Engineer' }},\n    @{ Name = 'Add-ADGroupMember'; Parameters = \n        @{Name = 'Identity'; ValidateSet = 'TestGroup'},\n        @{Name = 'Members'}},\n    @{ Name = 'Remove-ADGroupMember'; Parameters = \n        @{Name = 'Identity'; ValidateSet = 'TestGroup'},\n        @{Name = 'Members'}}\n  \n# OLD: VisibleFunctions = 'Invoke-Function1', @{ Name = 'Invoke-Function2'; Parameters = @{ Name = 'Parameter1'; ValidateSet = 'Item1', 'Item2' }, @{ Name = 'Parameter2'; ValidatePattern = 'L*' } }   \nVisibleFunctions = 'Reset-ContosoUserPassword'\n```\n\nThere are a few things to note about the above:\n1.  PowerShell will attempt to auto-load the modules needed for your Role Capability.\nYou may need to explicitly list module names in the \"ModulesToImport\" field if you notice problems with a module not being autoloaded.\n\n2.  If you aren't sure if a command is a cmdlet or a function, run `Get-Command` and look at the \"CommandType\"\n\n3.  The ValidatePattern allows you to use a regular expression to restrict parameter arguments if it is not easy to define a set of allowable values.\nYou cannot define both a ValidatePattern and ValidateSet for a single parameter.\n\n### Step 5: Register a new Session Configuration\nNext, you will create a new session configuration file that will expose your Role Capability to members of the \"JEA_NonAdmin_HelpDesk\" AD group. \n\nStart by creating and opening a new blank Session Configuration file in PowerShell ISE.\n```PowerShell\nNew-PSSessionConfigurationFile -Path \"$env:ProgramData\\JEAConfiguration\\HelpDeskDemo.pssc\" \nise \"$env:ProgramData\\JEAConfiguration\\HelpDeskDemo.pssc\"\n```\nModify the following fields in the PSSC file.\nIf you are working in your own environment, you should replace \"CONTOSO\\JEA_NonAdmins_Helpdesk\" with your own non-administrator user or group.\n```PowerShell\n# OLD: Description = ''\nDescription = 'An endpoint for active directory tasks.' \n\n# OLD: SessionType = 'Default'\nSessionType = 'RestrictedRemoteServer'\n\n# OLD: TranscriptDirectory = 'C:\\Transcripts\\'\nTranscriptDirectory = \"C:\\ProgramData\\JEAConfiguration\\Transcripts\"\n\n# OLD: RunAsVirtualAccount = $true\nRunAsVirtualAccount = $true\n\n# OLD: RoleDefinitions = @{ 'CONTOSO\\SqlAdmins' = @{ RoleCapabilities = 'SqlAdministration' }; 'CONTOSO\\ServerMonitors' = @{ VisibleCmdlets = 'Get-Process' } }\nRoleDefinitions = @{ 'CONTOSO\\JEA_NonAdmin_HelpDesk' = @{ RoleCapabilities =  'ADHelpDesk' }} \n```\nSave and register the Session Configuration\n```PowerShell\nRegister-PSSessionConfiguration -Name ADHelpDesk -Path \"$env:ProgramData\\JEAConfiguration\\HelpDeskDemo.pssc\" \n```\n### Test It Out!\nGet your non-administrator user credentials:\n```PowerShell\n$HelpDeskCred = Get-Credential\n```\nIf you followed the Set Up Users and Groups section, the credentials will be:\n-   Username = \"HelpDeskUser\"\n-   Password = \"pa$$w0rd\"\n\nRemote into the AD Helpdesk endpoint using the non-admin credential:\n```PowerShell\nEnter-PSSession -ComputerName . -ConfigurationName ADHelpDesk -Credential $HelpDeskCred \n```\nUse Set-ADUser to reset a user's title.\n```PowerShell\nSet-ADUser -Identity OperatorUser -Title Engineer \n```\nVerify that the title has changed.\n```PowerShell\nGet-ADUser -Identity OperatorUser -Property Title \n```\nNow, use Add-ADGroupMember to add a user to the TestGroup.\nNote: make sure you've created the TestGroup beforehand.\n```PowerShell\nAdd-ADGroupMember TestGroup -Member OperatorUser -Verbose \n```\nExit the session:\n```PowerShell\nExit-PSSession\n```\n### Key Concepts\n**NoLanguage Mode**:\nWhen PowerShell is in \"NoLanguage\" mode, users may only run commands; they cannot use any language elements.\nFor more information, run `Get-Help about_Language_Modes`.\n\n**PowerShell Functions**:\nPowerShell functions are bits of PowerShell code that you can call by name.\nFor more information, run `Get-Help about_Functions`.\n\n**ValidateSet/ValidatePattern**:\nWhen exposing a command, you can restrict valid arguments for specific parameters.\nA ValidateSet is a specific list of valid commands.\nA ValidatePattern is a regular expression that the arguments for that parameter must match.\n\n## Multi-machine Deployment and Maintenance\nAt this point, you have deployed JEA to local systems several times.\nBecause your production environment probably consists of more than one machine, it's important to walk through the critical steps in the deployment process that must be repeated on each machine.\n\n### High Level Steps:\n1.  Copy your modules (with Role Capabilities) to each node.\n2.  Copy your session configuration files to each node.\n3.  Run `Register-PSSessionConfiguration` with your session configuration.\n4.  Keep a copy of your session configuration and toolkits in a secure location.\nAs you make modifications, it's good to have a \"single source of truth.\"\n\n### Example Script\nHere's an example script for deployment.\nTo use it in your environment, you'll have to use the names/paths of real file shares and modules.\n```PowerShell\n# First, copy the session configuration and modules (containing role capability files) onto a file share you have access to.\nCopy-Item -Path 'C:\\Demo\\Demo.pssc' -Destination '\\\\FileShare\\JEA\\Demo.pssc'\nCopy-Item -Path 'C:\\Program Files\\WindowsPowerShell\\Modules\\SomeModule\\' -Recurse -Destination '\\\\FileShare\\JEA\\SomeModule'\n\n# Next, author a setup script (C:\\JEA\\Deploy.ps1) to run on each individual node\n    # Contents of C:\\JEA\\Deploy.ps1\n    New-Item -ItemType Directory -Path C:\\JEADeploy\n    Copy-Item -Path '\\\\FileShare\\JEA\\Demo.pssc' -Destination 'C:\\JEADeploy\\'\n    Copy-Item -Path '\\\\FileShare\\JEA\\SomeModule' -Recurse -Destination 'C:\\Program Files\\WindowsPowerShell\\Modules' # Remember, Role Capability Files are found in modules\n    if (Get-PSSessionConfiguration -Name JEADemo -ErrorAction SilentlyContinue)\n    {\n        Unregister-PSSessionConfiguration -Name JEADemo -ErrorAction Stop\n    }\n\n    Register-PSSessionConfiguration -Name JEADemo -Path 'C:\\JEADeploy\\Demo.pssc'\n    Remove-Item -Path 'C:\\JEADeploy' # Don't forget to clean up!\n\n# Now, invoke the script on all of the target machines.\n# Note: this requires PowerShell Remoting be enabled on each machine. Enabling PowerShell remoting is a requirement to use JEA as well.\n# You may need to provide the \"-Credential\" parameter if your current user account does not have admin permissions on these machines.\nInvoke-Command ComputerName 'Node1', 'Node2', 'Node3', 'NodeN' -FilePath 'C:\\JEA\\Deploy.ps1'\n\n# Finally, delete the session configuration and role capability files from the file share.\nRemove-Item -Path '\\\\FileShare\\JEA\\Demo.pssc'\nRemove-Item -Path '\\\\FileShare\\JEA\\SomeModule' -Recurse\n```\n### Modifying Capabilities\nWhen dealing with many machines, it's important that modifications are rolled out in a consistent manner.\nOnce JEA has a DSC Resource, this will help ensure your environment is in sync.\nUntil that time, we highly recommend you keep a master copy of your session configurations and re-deploy each time you make a modification.\n\n### Removing Capabilities\nTo remove your JEA configuration from your systems, use the following command on each machine:\n```PowerShell\nUnregister-PSSessionConfiguration -Name JEADemo \n```\n## Reporting on JEA\nBecause JEA allows non-privileged users to run in a privileged context, logging and auditing are extremely important.\nIn this section, we'll run through the tools you can use to help you with logging and reporting.\n\n### Reporting on JEA Actions\n#### Over-the-Shoulder Transcription\nOne of the quickest ways to get a summary of what's happening in a PowerShell session is to look over the shoulder of the person typing.\nYou see their commands, the output of those commands, and all is well.\nOr it's not, but at least you'll know.\nPowerShell transcription is designed to give you a similar view after the fact.\n\nWhen using the \"TranscriptDirectory\" field in your Session Configuration, PowerShell will automatically record a transcript of all actions taken in a given session.\nYou can find transcripts from your sessions in this document here: \"$env:ProgramData\\JEAConfiguration\\Transcripts\"\n\nAs you can tell, the transcript records information about the \"Connected\" user, the \"Run As\" user, the commands run in the session, and more.\nFor more information about PowerShell transcription, check out [this blog post](http://blogs.msdn.com/b/powershell/archive/2015/06/09/powershell-the-blue-team.aspx).\n\n#### PowerShell Event Logs\nWhen you have module logging turned on, all PowerShell actions are also recorded in regular Windows Event logs.\nThis is slightly messier to deal with when compared to transcripts, but the level of detail it gives you can be useful.\n\nIn the \"PowerShell\" operational log, Event ID 4104 will record each command invoked if you have enabled module logging.\n\n#### Other Event Logs\nUnlike PowerShell logs and transcripts, other logging mechanisms will not capture the \"Connected User\".\nYou will need to do some correlation between other logs and PowerShell logs to match up actions taken.\n\nIn the \"Windows Remote Management\" operational log, Event ID 193 will record the Connecting User's SID and Name, as well as the RunAs Virtual Account's SID to assist with this correlation.\nYou may have also noticed that the name of the RunAs Virtual Account includes the connecting user's domain and username at the end.\n\n### Reporting on JEA Configuration\n#### Get-PSSessionConfiguration\nIn order to accurately report on the state of your environment, it's important to know how many JEA endpoints you have set up on your machine.\n`Get-PSSessionConfiguration` does just that.\n \n#### Get-PSSessionCapability\nManually reporting on the capabilities of any given user through a JEA endpoint can be quite complex.\nYou would potentially need to inspect several role capabilities.\nFortunately, the \"Get-PSSessionCapability\" cmdlet does this.\n\nTo test this out, run the following command from an administrator PowerShell prompt:\n```PowerShell\nGet-PSSessionCapability -Username 'CONTOSO\\OperatorUser' -ConfigurationName JEADemo\n```\n## Conclusion \nAfter completing this guide, you should have the tools and vocabulary to create your own JEA endpoint. Thanks for reading!\n\n## Appendix\n\n## Key Concepts Used Throughout This Guide\n**PowerShell Remoting**:\nPowerShell remoting allows you to run PowerShell commands against remote machines.\nYou can operate against one or many computers, and use either temporary or persistent connections.\nIn this demo, you remoted into your local machine with an interactive session.\nJEA restricts the functionality available through PowerShell remoting.\nFor more information about PowerShell remoting, run `Get-Help about_Remote`.\n\n**\"RunAs\" User**:\nWhen using JEA, a non-administrator \"runs as\" a privileged \"Virtual Account.\"\nThe Virtual Account only lasts the duration of the remote session.\nThat is to say, it is created when a user connects to the endpoint, and destroyed when the user ends the session.\nBy default, the Virtual Account is a member of the local Administrators group.\nOn a domain controller, it is a member of Domain Admins.\nVirtual Accounts are local to the machine on which they are created, and do not have permissions outside of that machine.\nThis means that they are not registered in Active Directory (no RID is assigned).\nAdditionally, if an allowed command/script tries to access resources outside of the local machine, it will be accessing those resources under the machine's identity, not the Virtual Account identity.\n\n**\"Connected\" User**:\nThe non-administrator user who connects to the JEA endpoint and to whom roles are assigned.\nAny commands this user runs are run under the context of the RunAs User or virtual account.\n\n\n### Creating a Domain Controller\n\nThis document assumes that your machine is domain joined.\nIf you currently don't have a domain to join, this section can help you quickly stand up a domain controller using DSC.\n\n#### Prerequisites\n\n1.  The machine is on an internal network\n2.  The machine is not joined to an existing domain\n3.  The machine is running Windows Server 2016 or has WMF 5.0 installed\n\n#### Install xActiveDirectory\nIf your machine has an active internet connection, run the following command in an elevated PowerShell window:\n```PowerShell\nInstall-Module xActiveDirectory -Force \n```\nIf you do not have an internet connection, install xActiveDirectory to another machine and then copy the xActiveDirectory folder to the \"C:\\Program Files\\WindowsPowerShell\\Modules\" folder on your machine.\n\nTo confirm the installation succeeded, run the following command:\n```PowerShell\nGet-Module xActiveDirectory -ListAvailable\n``` \n\n#### Set up a domain with DSC\nCopy the following script in PowerShell to make your machine a Domain Controller in a new domain.\n**AUTHOR'S NOTE: THERE IS A KNOWN ISSUE WITH THE CREDENTIALS PROVIDED NOT BEING USED.  TO BE SAFE, DON'T FORGET YOUR LOCAL ADMIN PASSWORD.**\n\n```PowerShell\nSet-Item WSMan:\\localhost\\Client\\TrustedHosts -Value $env:COMPUTERNAME -Force \n\n# This \"MetaConfiguration\" sets the DSC Engine to automatically reboot if required\n[DscLocalConfigurationManager()]\nConfiguration MetaConfiguration\n{\n    Node $env:Computername\n    {\n        Settings\n        {\n            RebootNodeIfNeeded = $true\n        }\n    }\n    \n}\n\nMetaConfiguration\n# Apply the MetaConfiguration\nSet-DscLocalConfigurationManager .\\MetaConfiguration\n\n# Configure a domain controller of a new \"Contoso\" domain\nconfiguration DomainController\n{\n    param\n    (\n        $node,\n        $cred\n    )\n    Import-DscResource -ModuleName xActiveDirectory\n\n    Node $node\n    {\n        WindowsFeature ADDS\n        {\n            Ensure = 'Present'\n            Name = 'AD-Domain-Services'\n        }\n\n        xADDomain Contoso\n        {\n            DomainName = 'contoso.com'\n            DomainAdministratorCredential = $cred\n            SafemodeAdministratorPassword = $cred\n            DependsOn = '[WindowsFeature]ADDS'\n        }\n\n        file temp\n        {\n            DestinationPath = 'C:\\temp.txt'\n            Contents = 'Domain has been created'\n            DependsOn = '[xADDomain]Contoso'\n        }\n    }\n}\n\n$ConfigData = @{\n    AllNodes = @(\n        @{\n            NodeName = $env:Computername\n            PSDscAllowPlainTextPassword = $true\n        }\n    )\n}\n\n# Enter your desired password for the domain administrator (note, this will be stored as plain text)\nDomainController -cred (Get-Credential -Message \"Enter desired credential for domain administrator\") -node $env:Computername -configurationData $ConfigData\n\n# Apply the configuration to create the domain controller\nStart-DSCConfiguration -path .\\DomainController -ComputerName $env:Computername -Wait -Force -Verbose\n```\nYour machine will restart a few times.\nYou will know the process is complete once you see a file called \"C:\\temp.txt\" containing \"Domain has been created.\" \n\n#### Set up Users and Groups\nThe following commands will set up an Operator and Helpdesk group in your domain and a corresponding non-administrator user who is a member of that group.\n```PowerShell\n# Make Groups\n$NonAdminOperatorGroup = New-ADGroup -Name \"JEA_NonAdmin_Operator\" -GroupScope DomainLocal -PassThru\n$NonAdminHelpDeskGroup = New-ADGroup -Name \"JEA_NonAdmin_HelpDesk\" -GroupScope DomainLocal -PassThru\n$TestGroup = New-ADGroup -Name \"Test_Group\" -GroupScope DomainLocal -PassThru\n\n# Make Users\n$OperatorUser = New-ADUser -Name \"OperatorUser\" -AccountPassword (ConvertTo-SecureString \"pa`$`$w0rd\" -AsPlainText -Force) -PassThru\nEnable-ADAccount -Identity $OperatorUser\n\n$HelpDeskUser = New-ADUser -name \"HelpDeskUser\" -AccountPassword (ConvertTo-SecureString \"pa`$`$w0rd\" -AsPlainText -Force) -PassThru\nEnable-ADAccount -Identity $HelpDeskUser\n\n# Add Users to Groups\nAdd-ADGroupMember -Identity $NonAdminOperatorGroup -Members $OperatorUser\nAdd-ADGroupMember -Identity $NonAdminHelpDeskGroup -Members $HelpDeskUser\n```\n\n### On Blacklisting\nAfter playing around with JEA, you may be wondering if it is possible to blacklist commands.\nThis is an understandable request, but it is not currently planned for JEA for the following reasons:\n\n1.  We designed JEA to limit operators to only the actions they need to do.\nA blacklist is the opposite.\n\n2.  PowerShell command authors did not design PowerShell commands with the JEA in mind.\nOn a fresh install of Windows Server 2016, there are about 1520 commands immediately available.\nThe threat models for these commands did not include the possibility that a user would be running commands as a more privileged account.\nFor example, certain commands allow for code injection by design (e.g. Add-Type and Invoke-Command in the core PowerShell module).\nJEA can warn you when you expose the specific commands we know about, but we have not re-assessed every other command in Windows based on the new threat model.\nYou must understand the capabilities of the commands you exposing through JEA.  \n\n3.  Furthermore, even if JEA blocked all commands with code-injection vulnerabilities, there is no guarantee that a malicious user would not be able to carry out a blacklisted action with another related command.\nUnless you understand all of the commands that you are exposing, it is impossible for you to guarantee that a certain action is not possible.\nThe burden is on you to understand what commands you are exposing, whether they are using a whitelist or a blacklist.\nThe number of commands a blacklist would expose is unmanageable, so JEA is implemented using whitelists instead.\n\n### Considerations When Limiting Commands\nThere is one important point to make about this step.\nIt is critical that all capabilities exposed through JEA are located in administrator-restricted areas.\nNon-administrator users should not have the capability to modify the scripts used through JEA endpoints.\n\nOn a related note, it is critical that you do not give JEA users the ability to overwrite JEA configurations and whitelisted scripts within their JEA sessions.\nBe extremely careful when exposing commands like `Copy-Item`!\n\n### Common Role Capability Pitfalls\nYou may run into a few common pitfalls into you go through this process yourself.\nHere is a quick guide explaining how to identify and remediate these issues when modifying or creating a new endpoint:\n\n#### Functions vs. Cmdlets\nPowerShell commands written in PowerShell are PowerShell Functions.\nPowerShell commands written as specialized .NET classes are PowerShell Cmdlets.\nYou can check the command type by running `Get-Command`.\n\n#### VisibleProviders \nYou will need to expose any providers your commands need.\nThe most common is the FileSystem provider, but you may also need to expose others, like the Registry provider.\nFor an introduction to providers, check out this [Hey, Scripting Guy blog post](http://blogs.technet.com/b/heyscriptingguy/archive/2015/04/20/find-and-use-windows-powershell-providers.aspx).\nBe careful when exposing providers -- often, it is better to define your own function that works with the underlying providers than to directly expose the provider in a JEA session.\nThis way, you can still allow users to work with files, registry keys, etc. but retain control over **which* files and registry keys they can work with using custom validation logic."}