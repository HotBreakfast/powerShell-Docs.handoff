{"nodes":[{"content":"PowerShell Remoting Security Considerations","pos":[2,45]},{"content":"PowerShell Remoting is the recommended way to manage Windows systems.","pos":[47,116]},{"content":"PowerShell Remoting is enabled by default in Windows Server 2012 R2.","pos":[117,185]},{"content":"This document covers security concerns,","pos":[186,225]},{"content":"recommendations, and best practices when using PowerShell Remoting.","pos":[227,294]},{"content":"What is PowerShell Remoting?","pos":[299,327]},{"content":"PowerShell Remoting uses <bpt id=\"p1\">[</bpt>Windows Remote Management (WinRM)<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426.aspx)</ept>, which is the Microsoft implementation of the","pos":[329,507]},{"content":"<bpt id=\"p1\">[</bpt>Web Services for Managment (WS-Managment)<ept id=\"p1\">](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)</ept> protocol, to allow users to run PowerShell commands on remote","pos":[508,692]},{"content":"computers.","pos":[693,703]},{"content":"You can find more information about using PowerShell Remoting at <bpt id=\"p1\">[</bpt>Running Remote Commands<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/dd819505.aspx)</ept>.","pos":[704,854]},{"content":"PowerShell Remoting is not the same as using the <bpt id=\"p1\">**</bpt>ComputerName<ept id=\"p1\">**</ept> parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC)","pos":[856,1014]},{"content":"as its underlying protocol.","pos":[1015,1042]},{"content":"PowerShell Remoting default settings","pos":[1048,1084]},{"content":"PowerShell Remoting (and WinRM) listen on the following ports:","pos":[1086,1148]},{"content":"HTTP: 5985","pos":[1152,1162]},{"content":"HTTPS: 5986","pos":[1165,1176]},{"content":"By default, PowerShell Remoting only allows connections from members of the Administrator's group.","pos":[1178,1276]},{"content":"Sessions are launched under the user's context, so all operating","pos":[1277,1341]},{"content":"system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.","pos":[1342,1471]},{"content":"On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.","pos":[1473,1576]},{"content":"On public networks, the default Windows Firewall rule allows PowerShell","pos":[1577,1648]},{"content":"Remoting connections only from within the same subnet.","pos":[1649,1703]},{"content":"You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.","pos":[1704,1811]},{"pos":[1814,1993],"content":"**Warning:** The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts. Use caution when removing \nthis rule.","leadings":["",">"],"nodes":[{"content":"**Warning:** The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts. Use caution when removing","pos":[0,166],"nodes":[{"content":"<bpt id=\"p1\">**</bpt>Warning:<ept id=\"p1\">**</ept> The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.","pos":[0,140]},{"content":"Use caution when removing","pos":[141,166]}]},{"content":"this rule.","pos":[168,178]}]},{"content":"Process isolation","pos":[1998,2015]},{"content":"PowerShell Remoting uses <bpt id=\"p1\">[</bpt>Windows Remote Management (WinRM)<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426)</ept> for communication between computers.","pos":[2017,2181]},{"content":"WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.","pos":[2183,2326]},{"content":"An instance of PowerShell running as one","pos":[2327,2367]},{"content":"user has no access to a process running an instance of PowerShell as another user.","pos":[2368,2450]},{"content":"Event logs generated by Powershell Remoting","pos":[2455,2498]},{"content":"FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at","pos":[2500,2637]},{"content":"<bpt id=\"p1\">[</bpt>Investigating PowerShell Attacks<ept id=\"p1\">](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)</ept>.","pos":[2640,2800]},{"content":"Encryption and transport protocols","pos":[2805,2839]},{"content":"It is helpful to consider the security of a PowerShell Remoting connection security from two perspectives: initial authentication, and ongoing communication.","pos":[2841,2998]},{"content":"Regardless of the transport protocol used (HTTP or HTTPS), PowerShell Remoting always encrypts all communication after initial authentication with a per-session AES-256 symmetric key.","pos":[3001,3184]},{"content":"Initial authentication","pos":[3194,3216]},{"content":"Authentication confirms the identity of the client to the server - and ideally - the server to the client.","pos":[3218,3324]},{"content":"When a client connects to a domain server using its computer name (i.e.: server01, or server01.contoso.com), the default authentication protocol is","pos":[3330,3477]},{"content":"<bpt id=\"p1\">[</bpt>Kerberos<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378747.aspx)</ept>.","pos":[3479,3562]},{"content":"Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.","pos":[3563,3674]},{"content":"When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.","pos":[3676,3815]},{"content":"In that case, PowerShell","pos":[3816,3840]},{"content":"remoting relies on the <bpt id=\"p1\">[</bpt>NTLM authentication protocol<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378749.aspx)</ept>.","pos":[3841,3967]},{"content":"The NTLM authentication","pos":[3968,3991]},{"content":"protocol guarantees the user identity without sending any sort of delegable credential.","pos":[3992,4079]},{"content":"To prove user identity, the NTLM protocol requires that both the client","pos":[4080,4151]},{"content":"and server compute a session key from the user's password without ever exchanging the password itself.","pos":[4152,4254]},{"content":"The server typically does not know the user's password, so it communicates with","pos":[4255,4334]},{"content":"the domain controller, which does know the user's password and calculates the session key for the server.","pos":[4336,4441]},{"content":"The NTLM protocol does not, however, guarantee server identity.","pos":[4450,4513]},{"content":"As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine","pos":[4514,4631]},{"content":"account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.","pos":[4632,4741]},{"content":"NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting.","pos":[4743,4911]},{"content":"Using SSL certificates to validate server identity during NTLM-based connections","pos":[4922,5002]},{"content":"Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers","pos":[5004,5167]},{"content":"to use SSL for PowerShell Remoting.","pos":[5168,5203]},{"content":"Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables","pos":[5204,5327]},{"content":"NTLM-based authentication that guarantees both the user identity and server identity.","pos":[5328,5413]},{"content":"Ignoring NTLM-based server identity errors","pos":[5424,5466]},{"content":"If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM","pos":[5474,5633]},{"content":"<bpt id=\"p1\">**</bpt>TrustedHosts<ept id=\"p1\">**</ept> list.","pos":[5634,5656]},{"content":"Please note that adding a server name to the TrustedHosts list should not be considered as any form of statement of the trustworthiness of","pos":[5657,5795]},{"content":"the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.","pos":[5796,5948]},{"content":"Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.","pos":[5949,6126]},{"content":"Ongoing Communication","pos":[6141,6162]},{"content":"Once initial authentication is complete, the <bpt id=\"p1\">[</bpt>PowerShell Remoting Protocol<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/dd357801.aspx)</ept> encrypts all ongoing communication","pos":[6164,6330]},{"content":"with a per-session AES-256 symmetric key.","pos":[6331,6372]},{"content":"Making the second hop","pos":[6380,6401]},{"content":"By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.","pos":[6403,6491]},{"content":"Both of these protocols authenticate to the remote machine without sending credentials to it.","pos":[6492,6585]},{"content":"This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.","pos":[6586,6767]},{"content":"This is known as the \"Double-Hop\" problem.","pos":[6769,6811]},{"content":"There are several ways to avoid this problem:","pos":[6813,6858]},{"content":"Kerberos Constrained Delegation","pos":[6864,6895]},{"content":"For highly trusted servers, you can enable <bpt id=\"p1\">[</bpt>Kerberos Constrained Delegation<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/cc995228.aspx)</ept>.","pos":[6897,7033]},{"content":"This allows the remote server to impersonate the","pos":[7034,7082]},{"content":"authenticated user to a specified list of computers and services.","pos":[7083,7148]},{"content":"Trust between remote computers","pos":[7154,7184]},{"pos":[7186,7325],"content":"If you trust users connected remotely to <bpt id=\"p1\">*</bpt>Server1<ept id=\"p1\">*</ept> to resources on <bpt id=\"p2\">*</bpt>Server2<ept id=\"p2\">*</ept>, you can explicitly grant <bpt id=\"p3\">*</bpt>Server1<ept id=\"p3\">*</ept> access to those resources."},{"content":"Use explicit credentials when accessing remote resources","pos":[7331,7387]},{"content":"You can explicitly pass your credentials to a remote resource by using the <bpt id=\"p1\">**</bpt>Credential<ept id=\"p1\">**</ept> parameter of a cmdlet.","pos":[7389,7501]},{"content":"For example:","pos":[7502,7514]},{"content":"CredSSP","pos":[7644,7651]},{"content":"You can use the <bpt id=\"p1\">[</bpt>Credential Security Support Provicer (CredSSP)<ept id=\"p1\">](https://msdn.microsoft.com/en-us/library/windows/desktop/bb931352.aspx)</ept> for authentication (by specifying \"CredSSP\" as the","pos":[7653,7840]},{"content":"value of the <ph id=\"ph1\">`Authentication`</ph> parameter of a call to the <bpt id=\"p1\">[</bpt>New-PSSession<ept id=\"p1\">](https://technet.microsoft.com/en-us/library/hh849717.aspx)</ept> cmdlet.","pos":[7842,7981]},{"content":"CredSSP passes credentials in plain text to the server,","pos":[7982,8037]},{"content":"so using it opens you up to credential theft attacks.","pos":[8038,8091]},{"content":"If the remote computer is compromised, the attacker has access to the user's credentials.","pos":[8092,8181]},{"content":"CredSSP is disabled by default on both client and","pos":[8182,8231]},{"content":"server computers.","pos":[8233,8250]},{"content":"You should enable CredSSP only in the most trusted environments.","pos":[8251,8315]},{"content":"For example, a domain administrator connecting to a domain controller because the domain controller is","pos":[8316,8418]},{"content":"highly trusted.","pos":[8420,8435]},{"content":"For more information about security concerns when using CredSSP for PowerShell Remoting, see","pos":[8437,8529]},{"content":"<bpt id=\"p1\">[</bpt>Accidental Sabotage: Beware of CredSSP<ept id=\"p1\">](http://www.powershellmagazine.com/2014/03/06/accidental-sabotage-beware-of-credssp)</ept>.","pos":[8531,8656]},{"pos":[8658,8847],"content":"For more information about credential theft attacks, see <bpt id=\"p1\">[</bpt>Mitigating Pass-the-Hash (PtH) Attacks and Other Credential Theft<ept id=\"p1\">](https://www.microsoft.com/en-us/download/details.aspx?id=36036)</ept>."}],"content":"# PowerShell Remoting Security Considerations\n\nPowerShell Remoting is the recommended way to manage Windows systems. PowerShell Remoting is enabled by default in Windows Server 2012 R2. This document covers security concerns, \nrecommendations, and best practices when using PowerShell Remoting.\n\n## What is PowerShell Remoting?\n\nPowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426.aspx), which is the Microsoft implementation of the\n[Web Services for Managment (WS-Managment)](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote\ncomputers. You can find more information about using PowerShell Remoting at [Running Remote Commands](https://technet.microsoft.com/en-us/library/dd819505.aspx).\n\nPowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC)\nas its underlying protocol.\n\n##  PowerShell Remoting default settings\n\nPowerShell Remoting (and WinRM) listen on the following ports:\n\n- HTTP: 5985\n- HTTPS: 5986\n\nBy default, PowerShell Remoting only allows connections from members of the Administrator's group. Sessions are launched under the user's context, so all operating\nsystem access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.\n\nOn private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections. On public networks, the default Windows Firewall rule allows PowerShell\nRemoting connections only from within the same subnet. You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.\n\n>**Warning:** The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts. Use caution when removing \n>this rule.\n\n## Process isolation\n\nPowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426) for communication between computers. \nWinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances. An instance of PowerShell running as one\nuser has no access to a process running an instance of PowerShell as another user.\n\n## Event logs generated by Powershell Remoting\n\nFireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at  \n[Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).\n\n## Encryption and transport protocols\n\nIt is helpful to consider the security of a PowerShell Remoting connection security from two perspectives: initial authentication, and ongoing communication. \n\nRegardless of the transport protocol used (HTTP or HTTPS), PowerShell Remoting always encrypts all communication after initial authentication with a per-session AES-256 symmetric key.\n    \n### Initial authentication\n\nAuthentication confirms the identity of the client to the server - and ideally - the server to the client.\n    \nWhen a client connects to a domain server using its computer name (i.e.: server01, or server01.contoso.com), the default authentication protocol is \n[Kerberos](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378747.aspx).\nKerberos guarantees both the user identity and server identity without sending any sort of reusable credential.\n\nWhen a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible. In that case, PowerShell\nremoting relies on the [NTLM authentication protocol](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378749.aspx). The NTLM authentication\nprotocol guarantees the user identity without sending any sort of delegable credential. To prove user identity, the NTLM protocol requires that both the client\nand server compute a session key from the user's password without ever exchanging the password itself. The server typically does not know the user's password, so it communicates with \nthe domain controller, which does know the user's password and calculates the session key for the server. \n      \nThe NTLM protocol does not, however, guarantee server identity. As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine\naccount could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.\n\nNTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting.\n    \n#### Using SSL certificates to validate server identity during NTLM-based connections\n\nSince the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers\nto use SSL for PowerShell Remoting. Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables\nNTLM-based authentication that guarantees both the user identity and server identity.\n    \n#### Ignoring NTLM-based server identity errors\n      \nIf deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM\n**TrustedHosts** list. Please note that adding a server name to the TrustedHosts list should not be considered as any form of statement of the trustworthiness of\nthe hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.\nInstead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.\n    \n    \n### Ongoing Communication\n\nOnce initial authentication is complete, the [PowerShell Remoting Protocol](https://msdn.microsoft.com/en-us/library/dd357801.aspx) encrypts all ongoing communication\nwith a per-session AES-256 symmetric key.  \n\n\n## Making the second hop\n\nBy default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication. Both of these protocols authenticate to the remote machine without sending credentials to it.\nThis is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf. \nThis is known as the \"Double-Hop\" problem.\n\nThere are several ways to avoid this problem:\n\n### Kerberos Constrained Delegation\n\nFor highly trusted servers, you can enable [Kerberos Constrained Delegation](https://technet.microsoft.com/en-us/library/cc995228.aspx). This allows the remote server to impersonate the\nauthenticated user to a specified list of computers and services.\n\n### Trust between remote computers\n\nIf you trust users connected remotely to *Server1* to resources on *Server2*, you can explicitly grant *Server1* access to those resources.\n\n### Use explicit credentials when accessing remote resources\n\nYou can explicitly pass your credentials to a remote resource by using the **Credential** parameter of a cmdlet. For example:\n\n```powershell\n$myCredential = Get-Credential\nNew-PSDrive -Name Tools \\\\Server2\\Shared\\Tools -Credential $myCredential \n```\n\n### CredSSP\n\nYou can use the [Credential Security Support Provicer (CredSSP)](https://msdn.microsoft.com/en-us/library/windows/desktop/bb931352.aspx) for authentication (by specifying \"CredSSP\" as the \nvalue of the `Authentication` parameter of a call to the [New-PSSession](https://technet.microsoft.com/en-us/library/hh849717.aspx) cmdlet. CredSSP passes credentials in plain text to the server,\nso using it opens you up to credential theft attacks. If the remote computer is compromised, the attacker has access to the user's credentials. CredSSP is disabled by default on both client and \nserver computers. You should enable CredSSP only in the most trusted environments. For example, a domain administrator connecting to a domain controller because the domain controller is \nhighly trusted.\n\nFor more information about security concerns when using CredSSP for PowerShell Remoting, see \n[Accidental Sabotage: Beware of CredSSP](http://www.powershellmagazine.com/2014/03/06/accidental-sabotage-beware-of-credssp).\n\nFor more information about credential theft attacks, see [Mitigating Pass-the-Hash (PtH) Attacks and Other Credential Theft](https://www.microsoft.com/en-us/download/details.aspx?id=36036).\n\n\n\n\n\n\n\n\n"}